# 牙科门诊管理系统 — 架构优化与商业化实施路径

## 项目现状评估

> **最后更新：2026-02-04**

| 维度 | 初始现状 | 当前现状 | 风险等级 |
|---|---|---|---|
| 框架版本 | Laravel 5.8（已停止维护） | **Laravel 11.x**（已完成 5.8→6→8→9→10→11 升级） | ~~高危~~ → **已解决** |
| PHP 版本 | 7.2+（8.x 未适配） | **PHP 8.2+**（随 Laravel 11 适配） | ~~高危~~ → **已解决** |
| 前端架构 | jQuery + 零散 Vue 2.5，1.4MB 单文件 app.js | 未变更，jQuery + Bootstrap + DataTables | 中 |
| 测试覆盖 | 仅 2 个示例文件，接近 0% | 仍为 3 个示例文件，接近 0% | **高危** |
| API 层 | 无独立 API，全部 Web 路由 + AJAX | 未变更，仍为 Web 路由 + AJAX | 中 |
| 部署 | 无 Docker / CI-CD，手动部署 | 未变更 | 中 |
| 多租户 | 仅 branch_id 过滤，非真正隔离 | 未变更 | 中 |
| 支付集成 | 自建逻辑，无第三方网关 | 未变更 | 中 |
| SMS | 仅 AfricasTalking（非中国市场） | AfricasTalking 已移除，SMS 框架保留 | 低 |

### 功能模块统计

| 类别 | 数量 |
|---|---|
| 控制器 | 96 个 |
| 数据模型 | 92 个 |
| 数据库表 | 135 张 |
| Blade 视图 | 246 个 |
| 前端 JS 文件 | 36 个 |
| 语言文件 | 70+ 个/语言 |
| 角色模块 | 5 个（Doctor / Nurse / Receptionist / SuperAdmin / Pharmacy） |

### 已有核心功能清单

- **患者管理**：CRUD、病历、影像、标签、随访、过敏/慢性病/手术史
- **预约调度**：日历视图、医生排班、在线预约、候诊排队、牙椅管理
- **病例管理**：SOAP 病历、进展记录、诊断、治疗方案（分阶段）、处方、牙位图
- **账单系统**：发票、报价单、混合支付、退费审批、折扣审批、优惠券
- **会员体系**：会员等级、储值余额、积分、会员交易记录
- **医疗卡**：预付费套餐项目
- **库存管理**：出入库、批次、耗材关联、采购订单
- **人事薪酬**：员工合同、工资条、预支、津贴/扣款、假期审批
- **医生提成**：提成规则、佣金申报、提成支付
- **财务管理**：费用管理、费用分类、会计科目
- **报表**：日收入、医生绩效、欠费、保险理赔、就诊率、项目收入、预算分析
- **通信**：SMS 日志、生日祝福、账单邮件通知
- **系统管理**：角色权限（RBAC）、多门店、审计日志、i18n（中/英）

### 与市场主流产品功能差距分析

> 对标产品：牙医管家、领健·e看牙、CareStack、Dentrix、Open Dental 等主流口腔诊所管理系统。

| 功能模块 | 市场主流 | 本系统现状 | 差距等级 | 优先级 |
|---|---|---|---|---|
| **技工单/义齿加工管理** | 标配：外加工追踪、状态管理、费用核算、技工厂对接 | ❌ 设计文档中提及但代码未实现 | **高** | **P0** |
| **营销与 CRM/SCRM** | 标配：患者分级、沉睡唤醒、营销活动、渠道 ROI、微信 SCRM | ❌ 仅有患者标签和来源基础字段，无营销自动化 | **高** | P1 |
| **转诊管理** | 常见：诊所间转诊、专科转诊、转诊来源追踪 | ❌ 完全缺失 | 中 | P2 |
| **患者保险理赔** | 标配（国际）：保险资格验证、理赔提交、EOB 处理、AR 追踪 | ❌ 仅有医生提成理赔，无患者保险理赔流程 | 中 | P1 |
| **知情同意书管理** | 常见：独立同意书模板、电子签名、归档管理 | 🟡 治疗方案中有 `electronic_signature` 字段，无独立同意书管理 | 中 | P1 |
| **数字影像设备集成** | 标配：DICOM 协议、X 光/CBCT/口内相机直连、影像标注 | 🟡 有 `PatientImage` 基础上传（支持 X-Ray/CT/口内/口外分类），无设备直连和 DICOM | 中 | P2 |
| **电子表单/健康问卷** | 常见：初诊表、健康问卷、病史采集数字化 | 🟡 仅有满意度调查问卷，无初诊表/健康问卷 | 中 | P1 |
| **统一消息中心** | 标配：SMS + 邮件 + 站内信 + 微信统一收件箱 | 🟡 SMS 日志和 Laravel 通知已有，无统一消息中心 UI | 中 | P2 |
| **设备维护管理** | 常见：设备台账、维保记录、维保提醒 | 🟡 仅有牙椅（`Chair`）管理，无通用设备维保系统 | 低 | P3 |
| **患者门户/小程序** | 标配：在线预约、病历查看、账单支付、候诊查询 | 🟡 仅有 `OnlineBooking` 基础预约，非完整门户 | **高** | P1 |
| **公告/通知管理** | 常见：诊所内部公告板、通知发布与已读追踪 | 🟡 有 Laravel Notification 表，无专用公告 UI | 低 | P3 |
| **患者教育内容** | 加分项：术前术后指导、口腔保健知识库 | ❌ 完全缺失 | 低 | P3 |
| **员工在线培训** | 加分项：培训课程、考核、学习记录 | ❌ 完全缺失 | 低 | P3 |

#### 关键差距说明

**1. 技工单/义齿加工管理（P0 — 口腔诊所刚需）**

技工单是口腔诊所区别于其他医疗机构的核心业务流程，牙医管家和领健均将其作为核心模块。涉及：

```
lab_cases / 技工单
├── 基础信息：患者、医生、义齿类型、加工单位（技工厂）
├── 工艺信息：材料、颜色、咬合记录、特殊要求
├── 流程追踪：送出 → 制作中 → 返回 → 试戴 → 完成
├── 费用管理：加工费、患者收费、利润计算
├── 时间管理：预计交付日期、实际交付日期、超期预警
└── 质量管理：返工记录、质量评价
```

**2. 营销与 CRM（P1 — 商业化竞争力）**

主流竞品（领健 SCRM、牙医管家营销模块）均提供：

```
营销 CRM
├── 患者生命周期管理：新患 → 初诊 → 在治 → 复诊 → 沉睡 → 流失
├── 智能分群：按消费金额、就诊频次、项目类型自动分层
├── 营销活动：优惠券推送、节日营销、裂变活动
├── 渠道追踪：各渠道获客成本、转化率、ROI 分析
├── 沉睡唤醒：自动识别 N 天未就诊患者，触发提醒
└── 微信集成：服务号模板消息、小程序预约、社交分享
```

**3. 患者保险理赔（P1 — 国际市场必需）**

国际市场（Dentrix、CareStack、Open Dental）标配功能：

```
保险理赔管理
├── 保险资格验证：实时查询患者保险状态与覆盖范围
├── 理赔提交：自动生成 CDT 代码、电子提交理赔单
├── EOB 处理：保险公司回款对账、自动过账
├── AR 追踪：应收账款账龄分析、催收工作流
└── 预授权：术前预审批流程
```

> 注：中国市场医保对接需与当地医保系统接口对接，复杂度高，建议后期按需实施。

---

## 路线图实施进度总览

> **统计截止：2026-02-04** | 基于代码仓库 `upgrade/laravel-10` 分支实际情况

| 阶段 | 子项 | 完成度 | 说明 |
|---|---|---|---|
| **阶段一** 基础设施加固 | 1.1 Laravel 升级 | **✅ 100%** | 已完成 5.8→6→8→9→10→11.x 全部升级 |
|  | 1.2 测试体系 | **🔴 5%** | 仅 3 个示例测试文件，未建立业务测试 |
|  | 1.3 CI/CD | **🔴 0%** | 无 `.github/workflows` 配置 |
|  | 1.4 Docker 化 | **🔴 0%** | 无 `docker-compose.yml` |
| **阶段二** 架构优化 | 2.1 API 层抽离 | **🔴 0%** | `routes/api.php` 仍为默认空文件 |
|  | 2.2 Service 层 | **🔴 0%** | 无 `app/Services/` 目录，逻辑仍在 Controller 中 |
|  | 2.3 队列异步化 | **🔴 0%** | `QUEUE_CONNECTION=sync` 未变更 |
|  | 2.4 缓存策略 | **🔴 0%** | `CACHE_DRIVER=file` 未变更 |
| **阶段三** SaaS 化 | 3.1 ~ 3.3 | **🔴 0%** | 依赖阶段二完成，尚未启动 |
| **阶段四** 商业化功能 | 4.1 ~ 4.4 | **🔴 0%** | 尚未启动 |
|  | 4.5 技工单管理 (新增) | **🔴 0%** | P0 口腔刚需，代码未实现 |
|  | 4.6 营销与 CRM (新增) | **🔴 0%** | P1 商业化竞争力 |
|  | 4.7 知情同意书 (新增) | **🔴 0%** | P1 合规需要 |
|  | 4.8 电子表单/问卷 (新增) | **🔴 0%** | P1 减少纸质流程 |
| **阶段五** 运营增长 | 5.1 数据分析 | **🟡 40%** | 已有基础报表和聚合表，高级分析待建设 |
|  | 5.2 合规安全 | **🟡 30%** | 审计日志表已建，RBAC 权限表已建，加密/合规未实施 |
|  | 5.3 前端现代化 | **🔴 0%** | 未启动 |

**整体进度：阶段一进行中（核心阻塞项 1.1 已全部完成），阶段二~五尚未启动。**

---

## 阶段一：基础设施加固（商业化前提）

**目标**：消除技术债务，建立工程化基础，使系统具备可交付质量。

### 1.1 Laravel 版本升级路径 — ✅ 100% 完成

```
5.8 → 6.x → 7.x → 8.x → 9.x → 10.x → 11.x
              ↑ 跳过      ✅    ✅    ✅     ✅
```

**已完成的升级步骤：**

| 步骤 | 状态 | 提交记录 |
|---|---|---|
| 5.8 → 6.x | ✅ 已完成 | （合并在 6→8 中） |
| 6.x → 8.x | ✅ 已完成 | `188ee67` upgrade: Laravel 6.x → 8.x |
| Guzzle 升级到 7.x | ✅ 已完成 | `c89e9bb` chore: remove africastalking, upgrade Guzzle |
| 8.x → 9.x | ✅ 已完成 | `bb07ab1` upgrade: Laravel 8.x → 9.x with PHP 8.1 |
| 9.x → 10.x | ✅ 已完成 | `7062d90` upgrade: Laravel 9.x → 10.x |
| TrustProxies 适配 | ✅ 已完成 | `6cca1ea` fix: add HEADER_X_FORWARDED_PREFIX |
| 10.x → 11.x | ✅ 已完成 | 代码适配 + composer 升级 |

逐大版本升级，每一步：

- 用 `laravel-shift`（付费工具）自动化迁移差异
- 重点关注：
  - ~~5.8→6.0：`str_*` / `array_*` 全局 helper 移除~~ ✅
  - ~~7.0：路由缓存变化~~ （跳过 7.x，直接 6→8）
  - ~~8.0：Model Factory 重写、Job Batching~~ ✅
  - ~~9.0：要求 PHP 8.0+~~ ✅
  - ~~10.0：要求 PHP 8.1+~~ ✅
  - ~~11.0：要求 PHP 8.2+，移除多项废弃特性~~ ✅
- 每个版本跑通所有页面后再进入下一版本

**依赖包兼容矩阵**（已完成升级的标注当前版本）：

| 包 | 原始版本 | 当前版本 | 目标版本 | 状态 |
|---|---|---|---|---|
| `maatwebsite/excel` | 2.1 | 3.1 | 3.1+ | ✅ 已完成 |
| `yajra/datatables` | 9.7 | 10.0 | 11.x | 🟡 已升级，可继续 |
| `owen-it/laravel-auditing` | 10.0 | 13.0 | 13.x | ✅ 已完成 |
| `nwidart/laravel-modules` | 6.1 | 10.0 | 11.x | 🟡 已升级，可继续 |
| `maddhatter/laravel-fullcalendar` | 1.3 | 仍在使用 | 需替代方案 | ⬜ 待替换 |
| `jimmyjs/report-generator` | 1.1 | 仍在使用 | 需替代方案 | ⬜ 待替换 |
| `barryvdh/laravel-dompdf` | — | 2.0 | — | ✅ 已适配 |
| `spatie/laravel-backup` | — | 8.0 | — | ✅ 已适配 |

### 1.2 测试体系建设 — 🔴 5% 完成

**当前状态**：仅存在 3 个框架生成的示例测试文件（`tests/Feature/ExampleTest.php`、`tests/Feature/UserLogin.php`、`tests/Unit/ExampleTest.php`），无实际业务测试覆盖。PHPUnit 10.0 已配置。

按优先级分层建立：

```
Phase A: 冒烟测试                                    ⬜ 未开始
├── 登录/登出/权限拦截
├── 患者 CRUD
├── 预约 CRUD
└── 发票创建→支付→退费 完整流程

Phase B: 核心业务测试（持续）                         ⬜ 未开始
├── 财务计算（发票金额、退费上限、会员余额）
├── 权限矩阵（5 角色 × 关键路由）
├── 姓名 i18n（NameHelper 单元测试）
└── 数据隔离（branch_id 过滤）

Phase C: 回归测试                                    ⬜ 未开始
├── DataTables JSON 结构验证
├── PDF/Excel 导出
└── SMS/Email 发送（Mock）
```

### 1.3 CI/CD 管线 — 🔴 未开始

**当前状态**：项目中无 `.github/workflows/` 目录，未配置任何自动化管线。

```yaml
# .github/workflows/ci.yml 结构
触发: push / PR → master

Jobs:
  1. lint     → PHP-CS-Fixer + ESLint
  2. test     → PHPUnit (MySQL service container)
  3. build    → npm run production
  4. deploy   → 仅 master 合并后触发
```

### 1.4 Docker 化 — 🔴 未开始

**当前状态**：项目中无 `docker-compose.yml` 及相关 Docker 配置文件。

```
docker-compose.yml
├── app        (PHP-FPM + Laravel)
├── nginx      (Web 服务器)
├── mysql      (数据库)
├── redis      (缓存 + 队列)
└── scheduler  (Cron 任务)
```

---

## 阶段二：架构优化（可扩展性） — 🔴 未启动

> **前置依赖**：阶段 1.1 Laravel 升级已基本完成（10.x），本阶段可以开始推进。

### 2.1 API 层抽离 — 🔴 未开始

**当前状态**：`routes/api.php` 仍为 Laravel 默认空文件（仅含 `/api/user` 示例路由）。所有数据交互仍通过 Web 路由 + AJAX 方式，约 50+ 个 AJAX 端点散布在 `routes/web.php` 中。

当前所有数据交互都是 Web 路由 + AJAX，无法支撑移动端和第三方对接。

```
routes/
├── web.php     → 仅渲染页面（瘦化）
├── api/v1.php  → RESTful JSON API（新建）
│   ├── /api/v1/patients
│   ├── /api/v1/appointments
│   ├── /api/v1/invoices
│   ├── /api/v1/medical-cases
│   └── ...
└── api/v1 认证 → Laravel Sanctum（替代 session）
```

**实施策略：不重写，抽取**

- 将现有 Controller 的 `if ($request->ajax())` 分支抽取到独立 ApiController
- Web Controller 调用同一 Service 层
- 引入 `ApiResource` 统一 JSON 输出格式

### 2.2 Service 层引入 — 🔴 未开始

**当前状态**：项目中无 `app/Services/` 目录。业务逻辑仍全部在 Controller 中，100+ 个控制器未进行分层。

当前业务逻辑全部散落在 Controller 中（如 `InvoiceController` 700+ 行）。

```
App/
├── Http/Controllers/     → 仅处理 HTTP 请求/响应
├── Services/             → 业务逻辑（新建）
│   ├── PatientService.php
│   ├── AppointmentService.php
│   ├── InvoiceService.php
│   ├── RefundService.php
│   └── MemberService.php
└── Repositories/         → 可选，复杂查询封装
```

**优先抽取标准：涉及事务操作或跨模型操作的逻辑**

- `RefundController::store()` + `executeRefund()` → `RefundService`
- `InvoiceController` 的金额计算 → `InvoiceService`
- `MemberController::deposit()` → `MemberService`

### 2.3 队列异步化 — 🔴 未开始

**当前状态**：`.env.example` 中 `QUEUE_CONNECTION=sync` 未变更。`SendAppointmentSms` Job 已存在但仍以同步方式运行。

当前 `QUEUE_CONNECTION=sync`，所有操作同步阻塞。

需异步化的任务：

| 任务 | 当前 | 目标 |
|---|---|---|
| SMS 发送 | `SendAppointmentSms` Job 已有但 sync | Redis 队列 |
| Email 发送 | 同步 SMTP | 队列 + 失败重试 |
| PDF 生成 | 同步 DomPDF | 队列（大批量导出时） |
| Excel 导出 | 同步（大数据量超时） | 队列 + 下载通知 |
| 审计日志写入 | 同步 | 队列 |

### 2.4 缓存策略 — 🔴 未开始

**当前状态**：`.env.example` 中 `CACHE_DRIVER=file` 未变更，无 Redis 配置。

```
当前: CACHE_DRIVER=file（无缓存价值）
目标: CACHE_DRIVER=redis

缓存对象:
├── 权限矩阵       → 角色权限关系，TTL=1h，角色变更时清除
├── 系统配置       → 诊所信息、会员等级列表，TTL=24h
├── 医疗服务列表   → medical_services 表，TTL=6h
├── 保险公司列表   → insurance_companies 表，TTL=24h
└── DataTables 热数据 → 可选，按场景评估
```

---

## 阶段三：多租户 SaaS 化 — 🔴 未启动

> **前置依赖**：依赖阶段二架构优化完成。当前阶段二尚未开始，本阶段暂不具备启动条件。

### 3.1 多租户隔离方案

当前仅有 `branch_id` 字段，适合单诊所多门店。SaaS 化需要诊所级别隔离。

**推荐方案：共享数据库 + tenant_id 行级隔离**

```
理由：
- 现有 135 张表，独立数据库方案迁移成本过高
- 行级隔离 + Global Scope 足够满足中小诊所场景
- 使用 stancl/tenancy 包或自建 Global Scope

实施：
1. 新增 tenants 表（诊所主体）
2. 所有业务表添加 tenant_id 字段
3. 添加 TenantScope（Global Scope），自动注入 where tenant_id = ?
4. 中间件从域名/子域名解析 tenant
5. 迁移脚本：现有数据统一分配到 tenant_id = 1
```

### 3.2 域名与路由

```
方案 A（子域名）: clinic-a.yourdomain.com
方案 B（路径前缀）: yourdomain.com/clinic-a/
方案 C（自定义域名）: clinic-a-own-domain.com → 需 SSL 自动化

推荐：先 A，后期支持 C（商业价值高）
```

### 3.3 数据隔离验证清单

- [ ] 患者数据：仅本诊所可见
- [ ] 预约/病例：跨诊所不可访问
- [ ] 财务数据：发票/退费严格隔离
- [ ] 员工数据：可属于多诊所（多对多）
- [ ] 系统配置：诊所级别独立配置
- [ ] 报表数据：仅统计本诊所
- [ ] 审计日志：带 tenant_id

---

## 阶段四：商业化功能补齐 — 🔴 未启动

> **前置依赖**：依赖阶段二 API 层和 Service 层完成。当前仍使用自建支付逻辑和 Web 路由 AJAX 模式。

### 4.1 支付网关集成

| 市场 | 网关 | 优先级 |
|---|---|---|
| 中国 | 微信支付 + 支付宝 | P0 |
| 国际 | Stripe | P1 |
| 东南亚 | GrabPay / OVO | P2 |

```php
// 抽象支付接口
interface PaymentGateway {
    public function charge(float $amount, array $options): PaymentResult;
    public function refund(string $transactionId, float $amount): RefundResult;
    public function queryStatus(string $transactionId): TransactionStatus;
}

// 实现
App\Services\Payment\
├── PaymentGatewayFactory.php
├── WechatPayGateway.php
├── AlipayGateway.php
├── StripeGateway.php
└── CashGateway.php（现有现金逻辑迁入）
```

### 4.2 SMS 通道适配

当前仅 AfricasTalking，中国市场需要：

| 通道 | 用途 |
|---|---|
| 阿里云短信 | 预约提醒、验证码 |
| 腾讯云短信 | 备用通道 |
| 微信模板消息 | 预约确认、报告通知 |

同样抽象为 `SmsChannel` 接口 + 工厂模式。

### 4.3 患者端小程序/H5

基于阶段二的 API 层：

```
患者端功能:
├── 在线预约（已有 OnlineBooking 基础）
├── 候诊排队查看
├── 电子病历查看
├── 账单支付
├── 满意度评价（已有 SatisfactionSurvey 基础）
└── 会员余额/积分查询
```

技术选型：微信小程序（中国市场）或 Flutter（国际市场）

### 4.5 技工单/义齿加工管理 — 🔴 未开始（新增）

> **市场差距分析中识别的 P0 缺失功能**，口腔诊所核心业务流程。

```
数据模型:
lab_cases（技工单）
├── lab_case_no          -- 技工单编号
├── patient_id, doctor_id, appointment_id, medical_case_id
├── lab_id               -- 关联技工厂
├── prosthesis_type      -- 义齿类型（冠、桥、活动义齿、种植体等）
├── material             -- 材料（氧化锆、金属烤瓷、全瓷等）
├── color_shade          -- 比色信息
├── teeth_positions      -- 牙位（JSON）
├── special_requirements -- 特殊工艺要求
├── status               -- 待送出/制作中/已返回/试戴/完成/返工
├── sent_date, expected_return_date, actual_return_date
├── lab_fee, patient_charge
└── quality_rating, rework_count, rework_reason

labs（技工厂）
├── name, contact, phone, address
├── specialties          -- 擅长类型
└── avg_turnaround_days  -- 平均交付天数
```

**核心功能**：
- 技工单 CRUD，关联患者/医生/病例
- 技工厂管理（供应商子类型）
- 状态流转追踪与超期预警
- 费用核算（加工成本 vs 患者收费）
- 返工/质量追踪
- 技工单打印

### 4.6 营销与 CRM — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**，商业化核心竞争力。

```
Phase A: 基础 CRM（优先）
├── 患者生命周期标签：新患/初诊/在治/复诊/沉睡/流失（基于就诊记录自动计算）
├── 沉睡患者识别：N 天未就诊自动标记，支持批量提醒
├── 营销活动管理：活动创建、目标人群、效果追踪
└── 渠道 ROI 分析：基于现有 patient_sources 数据增强

Phase B: 高级 SCRM（后期）
├── 微信服务号集成：模板消息推送
├── 小程序营销：拼团、裂变、分享有礼
├── 智能推荐：基于历史治疗推荐后续项目
└── 患者画像看板：消费力、忠诚度、价值分层可视化
```

### 4.7 知情同意书管理 — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**。

```
consent_templates（同意书模板）
├── template_name, template_type（手术/麻醉/影像/通用）
├── content              -- 富文本内容
├── required_for_services -- 关联的医疗服务项目（JSON）
└── version, is_active

patient_consents（患者签署记录）
├── patient_id, template_id, medical_case_id
├── signed_at, signature_image
├── witness_name, doctor_id
└── pdf_path             -- 存档 PDF
```

### 4.8 电子表单/健康问卷 — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**。初诊信息采集数字化，减少纸质表单。

```
form_templates（表单模板）
├── name, type（初诊表/健康问卷/儿童问卷/术前评估）
├── fields              -- JSON Schema 定义表单字段
└── is_active, version

form_submissions（患者提交）
├── patient_id, template_id
├── data                -- JSON 提交数据
├── submitted_at, submitted_via（现场iPad/在线/小程序）
└── reviewed_by, reviewed_at
```

### 4.4 订阅计费系统

```sql
-- plans 表
plans:
├── id, name, code
├── max_patients      -- 患者上限
├── max_users         -- 员工账号上限
├── max_branches      -- 门店上限
├── features          -- JSON: 功能开关列表
├── price_monthly
├── price_yearly
└── is_trial

-- tenant_subscriptions 表
tenant_subscriptions:
├── tenant_id
├── plan_id
├── status (trial / active / past_due / cancelled)
├── current_period_start
├── current_period_end
└── payment_gateway_subscription_id
```

功能门控：

```php
// 中间件检查
if (!tenant()->canUse('inventory_module')) {
    abort(403, '请升级套餐以使用库存管理功能');
}
```

---

## 阶段五：运营与增长 — 🟡 部分推进

### 5.1 数据分析增强 — 🟡 40% 完成

**已完成的基础设施**：
- ✅ `daily_reports`、`monthly_reports` 聚合表已建立（migration 2026-01-17）
- ✅ `patient_analytics`、`doctor_performance` 分析表已建立
- ✅ 7 个报表控制器已实现（日收入、医生绩效、保险、项目收入、预算、欠费、就诊率）
- ✅ 6 个图表类已实现（月度现金流、患者趋势、费用分析、收入趋势等）
- ✅ 所有报表支持 Excel 导出
- ⬜ 高级分析（同比环比、LTV、流失预警）未实现
- ⬜ 经营驾驶舱未实现

| 报表 | 现有 | 需补齐 | 当前状态 |
|---|---|---|---|
| 营收分析 | 日报 ✓ | 周/月/年趋势、同比环比 | 🟡 基础已有 |
| 医生绩效 | 基础 ✓ | 客单价、复诊转化率、时段效率 | 🟡 基础已有 |
| 患者画像 | 来源 ✓ | 生命周期价值(LTV)、流失预警 | 🟡 基础已有 |
| 库存预警 | ~~无~~ 已有 | 安全库存、消耗趋势、自动补货建议 | 🟡 低库存/过期预警已实现 |
| 经营驾驶舱 | 无 | 管理者首页 Dashboard（关键指标一屏） | 🔴 未开始 |

### 5.2 合规与安全 — 🟡 30% 完成

**已完成的基础设施**：
- ✅ 审计日志表已建立：`login_logs`、`operation_logs`、`access_logs`、`exception_logs`（migration 2026-01-17）
- ✅ `owen-it/laravel-auditing` v13.0 已集成，`audits` 表已建立
- ✅ RBAC 权限系统已建立：`permissions`、`role_permissions` 表（migration 2025-11-16），支持数据库驱动的动态权限
- ✅ `spatie/laravel-backup` v8.0 已集成
- ⬜ 以下项目尚未实施

- [ ] 数据加密：患者敏感字段（身份证、手机号）AES 加密存储
- [x] 操作审计：~~已有 OperationLog 基础，需补全覆盖面~~ 四类审计日志表已建立（login/operation/access/exception），`laravel-auditing` 包已集成
- [x] 数据备份：`spatie/laravel-backup` v8.0 已集成，需配置异地备份策略
- [x] RBAC 细化：~~当前 5 角色偏粗~~ 已建立 `permissions` + `role_permissions` 表，支持自定义权限组合（`AuthServiceProvider` 中动态注册）
- [ ] 隐私合规：GDPR（国际）/ 《个人信息保护法》（中国）
- [ ] 数据导出/删除：患者有权要求导出或删除其个人数据

### 5.3 前端现代化（可选，长期） — 🔴 未开始

```
当前: jQuery + 零散 Vue 2 + 1.4MB app.js

路径 A（渐进式，推荐）:
  - 保留 Blade 服务端渲染
  - 逐页引入 Vue 3 组件（通过 Vite）
  - 替换 jQuery DataTables → Vue DataTable 组件
  - 风险低，可持续推进

路径 B（重写前端）:
  - 前后端分离：Vue 3 / React SPA + API
  - 一步到位但工程量巨大
  - 仅在团队规模足够时考虑

推荐: 路径 A，商业化初期不需要重写前端
```

---

## 实施优先级与依赖关系

```
阶段一 基础设施加固                            状态
│
├─ 1.1 Laravel升级 ──────────────────┐        ✅ 100%（5.8→11.x 全部完成）
├─ 1.2 测试体系（可并行）            │        🔴 5%
├─ 1.3 CI/CD（可并行）               │        🔴 0%
└─ 1.4 Docker化（可并行）            │        🔴 0%
                                      ▼
阶段二 架构优化 ◄────────────────── 依赖1.1完成（✅ 已满足）
│                                             🔴 全部未开始
├─ 2.1 API层抽离
├─ 2.2 Service层（可并行）
├─ 2.3 队列异步化（可并行）
└─ 2.4 缓存策略（可并行）
          │
          ▼
┌─────────┴──────────┐
▼                    ▼
阶段三 SaaS化     阶段四 商业化功能            🔴 全部未开始
│                 │
├─ 3.1 多租户     ├─ 4.1 支付网关
├─ 3.2 域名路由   ├─ 4.2 SMS适配
└─ 3.3 数据隔离   ├─ 4.3 患者端
                   ├─ 4.4 订阅计费
                   ├─ 4.5 技工单管理 ←── 新增(P0)
                   ├─ 4.6 营销CRM   ←── 新增(P1)
                   ├─ 4.7 知情同意书 ←── 新增(P1)
                   └─ 4.8 电子表单   ←── 新增(P1)
          │                │
          └────────┬───────┘
                   ▼
             阶段五 运营增长                   🟡 部分推进
             ├─ 5.1 数据分析                   🟡 40%
             ├─ 5.2 合规安全                   🟡 30%
             └─ 5.3 前端现代化                 🔴 0%
```

**关键路径分析**：阶段 1.1 Laravel 升级作为全局阻塞项已基本完成（10.x），当前可以并行推进阶段 1.2~1.4（测试/CI-CD/Docker）和阶段二（架构优化）。阶段五的部分基础设施（审计日志、权限系统、报表框架）已提前建设，属于正向进展。

---

## 商业化定价建议

基于口腔诊所管理 SaaS 市场：

| 版本 | 目标客户 | 核心功能 | 限制 |
|---|---|---|---|
| 免费版 | 个体诊所试用 | 患者 + 预约 + 基础账单 | 1 用户、200 患者 |
| 标准版 | 单店诊所 | 全功能 + 库存 + 报表 | 5 用户、1 门店 |
| 专业版 | 连锁诊所 | 多门店 + 会员 + 绩效 + API | 20 用户、5 门店 |
| 企业版 | 大型连锁/DSO | 自定义域名 + 数据分析 + 专属支持 | 不限 |

**建议首先推出标准版**，项目当前功能已覆盖单店诊所核心需求，阶段一加固完成后即可开始小范围收费试运营，用真实客户反馈驱动后续迭代优先级。

---

## 下一步优先行动建议

基于当前进度和市场差距分析，建议按以下优先级推进：

**基础设施（阻塞性）：**

1. ~~**完成 Laravel 10→11 升级**（1.1 收尾）~~ ✅ 已完成
2. **建立冒烟测试**（1.2 Phase A）— 保障核心流程（登录、患者 CRUD、预约、发票）不回归
3. **配置 CI/CD**（1.3）— GitHub Actions 基础管线，确保每次提交自动测试

**架构优化（并行推进）：**

4. **引入 Service 层**（2.2）— 从最复杂的 `InvoiceController` 和 `RefundController` 开始抽取，为后续 API 层奠定基础
5. **API 层建设**（2.1）— 优先抽取患者和预约模块的 API，为患者端小程序做准备

**功能补齐（可与架构优化并行，不依赖 API 层）：**

6. **技工单管理**（4.5 新增 P0）— 口腔诊所核心差异化业务流程，竞品标配功能，建议尽早实现
7. **知情同意书 + 电子表单**（4.7 + 4.8 新增 P1）— 合规需要且开发量适中，可快速见效
8. **营销 CRM 基础**（4.6 新增 P1）— 先实现患者生命周期标签和沉睡唤醒，利用现有 patient_sources / patient_tags 数据

---

## 参考资料

- [牙医管家官网](https://www.dentalink.com.cn/) — 国内市占率最高的口腔诊所 SaaS
- [领健·e看牙官网](https://www.linkedcare.cn/kouqiang) — PMS + EMR + CRM + SCRM 一体化方案
- [CareStack](https://carestack.com/) — 国际市场全功能云端牙科管理系统
- [Top Features of Dental Practice Management Software 2025](https://adit.com/top-features-dental-practice-management-software-2025)
- [Top 10 Dental Practice Management Software 2026](https://www.certifyhealth.com/blog/top-10-dental-practice-management-software-2026/)
- [What Is Dental Practice Management Software](https://www.oryxdental.com/what-is-dental-practice-management-software/)
- [Top 11 Features to Look for in Dental PMS](https://mconsent.net/blog/features-dental-practice-management-software/)
- [口腔诊所管理系统最全分析](https://www.jiushuyun.com/blog/yy/25256.html)
