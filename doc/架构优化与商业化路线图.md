# 牙科门诊管理系统 — 架构优化与商业化实施路径

## 项目现状评估

| 维度 | 现状 | 风险等级 |
|---|---|---|
| 框架版本 | Laravel 5.8（2019 年，已停止维护） | **高危** |
| PHP 版本 | 7.2+（8.x 未适配） | **高危** |
| 前端架构 | jQuery + 零散 Vue 2.5，1.4MB 单文件 app.js | 中 |
| 测试覆盖 | 仅 2 个示例文件，接近 0% | **高危** |
| API 层 | 无独立 API，全部 Web 路由 + AJAX | 中 |
| 部署 | 无 Docker / CI-CD，手动部署 | 中 |
| 多租户 | 仅 branch_id 过滤，非真正隔离 | 中 |
| 支付集成 | 自建逻辑，无第三方网关 | 中 |
| SMS | 仅 AfricasTalking（非中国市场） | 低 |

### 功能模块统计

| 类别 | 数量 |
|---|---|
| 控制器 | 96 个 |
| 数据模型 | 92 个 |
| 数据库表 | 135 张 |
| Blade 视图 | 246 个 |
| 前端 JS 文件 | 36 个 |
| 语言文件 | 70+ 个/语言 |
| 角色模块 | 5 个（Doctor / Nurse / Receptionist / SuperAdmin / Pharmacy） |

### 已有核心功能清单

- **患者管理**：CRUD、病历、影像、标签、随访、过敏/慢性病/手术史
- **预约调度**：日历视图、医生排班、在线预约、候诊排队、牙椅管理
- **病例管理**：SOAP 病历、进展记录、诊断、治疗方案（分阶段）、处方、牙位图
- **账单系统**：发票、报价单、混合支付、退费审批、折扣审批、优惠券
- **会员体系**：会员等级、储值余额、积分、会员交易记录
- **医疗卡**：预付费套餐项目
- **库存管理**：出入库、批次、耗材关联、采购订单
- **人事薪酬**：员工合同、工资条、预支、津贴/扣款、假期审批
- **医生提成**：提成规则、佣金申报、提成支付
- **财务管理**：费用管理、费用分类、会计科目
- **报表**：日收入、医生绩效、欠费、保险理赔、就诊率、项目收入、预算分析
- **通信**：SMS 日志、生日祝福、账单邮件通知
- **系统管理**：角色权限（RBAC）、多门店、审计日志、i18n（中/英）

---

## 阶段一：基础设施加固（商业化前提）

**目标**：消除技术债务，建立工程化基础，使系统具备可交付质量。

### 1.1 Laravel 版本升级路径

```
5.8 → 6.x → 7.x → 8.x → 9.x → 10.x → 11.x
```

逐大版本升级，每一步：

- 用 `laravel-shift`（付费工具）自动化迁移差异
- 重点关注：
  - 5.8→6.0：`str_*` / `array_*` 全局 helper 移除
  - 7.0：路由缓存变化
  - 8.0：Model Factory 重写、Job Batching
  - 9.0：要求 PHP 8.0+
  - 10.0：要求 PHP 8.1+
- 每个版本跑通所有页面后再进入下一版本

**依赖包兼容矩阵**（需同步升级）：

| 包 | 当前版本 | 目标版本 | 阻断风险 |
|---|---|---|---|
| `maatwebsite/excel` | 2.1 | 3.1+ | 高（API 完全重写） |
| `yajra/datatables` | 9.7 | 11.x | 低（向后兼容好） |
| `owen-it/laravel-auditing` | 10.0 | 13.x | 中 |
| `nwidart/laravel-modules` | 6.1 | 11.x | 中 |
| `maddhatter/laravel-fullcalendar` | 1.3 | 需替代方案 | 高（已停更） |
| `jimmyjs/report-generator` | 1.1 | 需替代方案 | 高（已停更） |

### 1.2 测试体系建设

按优先级分层建立：

```
Phase A: 冒烟测试
├── 登录/登出/权限拦截
├── 患者 CRUD
├── 预约 CRUD
└── 发票创建→支付→退费 完整流程

Phase B: 核心业务测试（持续）
├── 财务计算（发票金额、退费上限、会员余额）
├── 权限矩阵（5 角色 × 关键路由）
├── 姓名 i18n（NameHelper 单元测试）
└── 数据隔离（branch_id 过滤）

Phase C: 回归测试
├── DataTables JSON 结构验证
├── PDF/Excel 导出
└── SMS/Email 发送（Mock）
```

### 1.3 CI/CD 管线

```yaml
# .github/workflows/ci.yml 结构
触发: push / PR → master

Jobs:
  1. lint     → PHP-CS-Fixer + ESLint
  2. test     → PHPUnit (MySQL service container)
  3. build    → npm run production
  4. deploy   → 仅 master 合并后触发
```

### 1.4 Docker 化

```
docker-compose.yml
├── app        (PHP-FPM + Laravel)
├── nginx      (Web 服务器)
├── mysql      (数据库)
├── redis      (缓存 + 队列)
└── scheduler  (Cron 任务)
```

---

## 阶段二：架构优化（可扩展性）

### 2.1 API 层抽离

当前所有数据交互都是 Web 路由 + AJAX，无法支撑移动端和第三方对接。

```
routes/
├── web.php     → 仅渲染页面（瘦化）
├── api/v1.php  → RESTful JSON API（新建）
│   ├── /api/v1/patients
│   ├── /api/v1/appointments
│   ├── /api/v1/invoices
│   ├── /api/v1/medical-cases
│   └── ...
└── api/v1 认证 → Laravel Sanctum（替代 session）
```

**实施策略：不重写，抽取**

- 将现有 Controller 的 `if ($request->ajax())` 分支抽取到独立 ApiController
- Web Controller 调用同一 Service 层
- 引入 `ApiResource` 统一 JSON 输出格式

### 2.2 Service 层引入

当前业务逻辑全部散落在 Controller 中（如 `InvoiceController` 700+ 行）。

```
App/
├── Http/Controllers/     → 仅处理 HTTP 请求/响应
├── Services/             → 业务逻辑（新建）
│   ├── PatientService.php
│   ├── AppointmentService.php
│   ├── InvoiceService.php
│   ├── RefundService.php
│   └── MemberService.php
└── Repositories/         → 可选，复杂查询封装
```

**优先抽取标准：涉及事务操作或跨模型操作的逻辑**

- `RefundController::store()` + `executeRefund()` → `RefundService`
- `InvoiceController` 的金额计算 → `InvoiceService`
- `MemberController::deposit()` → `MemberService`

### 2.3 队列异步化

当前 `QUEUE_CONNECTION=sync`，所有操作同步阻塞。

需异步化的任务：

| 任务 | 当前 | 目标 |
|---|---|---|
| SMS 发送 | `SendAppointmentSms` Job 已有但 sync | Redis 队列 |
| Email 发送 | 同步 SMTP | 队列 + 失败重试 |
| PDF 生成 | 同步 DomPDF | 队列（大批量导出时） |
| Excel 导出 | 同步（大数据量超时） | 队列 + 下载通知 |
| 审计日志写入 | 同步 | 队列 |

### 2.4 缓存策略

```
当前: CACHE_DRIVER=file（无缓存价值）
目标: CACHE_DRIVER=redis

缓存对象:
├── 权限矩阵       → 角色权限关系，TTL=1h，角色变更时清除
├── 系统配置       → 诊所信息、会员等级列表，TTL=24h
├── 医疗服务列表   → medical_services 表，TTL=6h
├── 保险公司列表   → insurance_companies 表，TTL=24h
└── DataTables 热数据 → 可选，按场景评估
```

---

## 阶段三：多租户 SaaS 化

### 3.1 多租户隔离方案

当前仅有 `branch_id` 字段，适合单诊所多门店。SaaS 化需要诊所级别隔离。

**推荐方案：共享数据库 + tenant_id 行级隔离**

```
理由：
- 现有 135 张表，独立数据库方案迁移成本过高
- 行级隔离 + Global Scope 足够满足中小诊所场景
- 使用 stancl/tenancy 包或自建 Global Scope

实施：
1. 新增 tenants 表（诊所主体）
2. 所有业务表添加 tenant_id 字段
3. 添加 TenantScope（Global Scope），自动注入 where tenant_id = ?
4. 中间件从域名/子域名解析 tenant
5. 迁移脚本：现有数据统一分配到 tenant_id = 1
```

### 3.2 域名与路由

```
方案 A（子域名）: clinic-a.yourdomain.com
方案 B（路径前缀）: yourdomain.com/clinic-a/
方案 C（自定义域名）: clinic-a-own-domain.com → 需 SSL 自动化

推荐：先 A，后期支持 C（商业价值高）
```

### 3.3 数据隔离验证清单

- [ ] 患者数据：仅本诊所可见
- [ ] 预约/病例：跨诊所不可访问
- [ ] 财务数据：发票/退费严格隔离
- [ ] 员工数据：可属于多诊所（多对多）
- [ ] 系统配置：诊所级别独立配置
- [ ] 报表数据：仅统计本诊所
- [ ] 审计日志：带 tenant_id

---

## 阶段四：商业化功能补齐

### 4.1 支付网关集成

| 市场 | 网关 | 优先级 |
|---|---|---|
| 中国 | 微信支付 + 支付宝 | P0 |
| 国际 | Stripe | P1 |
| 东南亚 | GrabPay / OVO | P2 |

```php
// 抽象支付接口
interface PaymentGateway {
    public function charge(float $amount, array $options): PaymentResult;
    public function refund(string $transactionId, float $amount): RefundResult;
    public function queryStatus(string $transactionId): TransactionStatus;
}

// 实现
App\Services\Payment\
├── PaymentGatewayFactory.php
├── WechatPayGateway.php
├── AlipayGateway.php
├── StripeGateway.php
└── CashGateway.php（现有现金逻辑迁入）
```

### 4.2 SMS 通道适配

当前仅 AfricasTalking，中国市场需要：

| 通道 | 用途 |
|---|---|
| 阿里云短信 | 预约提醒、验证码 |
| 腾讯云短信 | 备用通道 |
| 微信模板消息 | 预约确认、报告通知 |

同样抽象为 `SmsChannel` 接口 + 工厂模式。

### 4.3 患者端小程序/H5

基于阶段二的 API 层：

```
患者端功能:
├── 在线预约（已有 OnlineBooking 基础）
├── 候诊排队查看
├── 电子病历查看
├── 账单支付
├── 满意度评价（已有 SatisfactionSurvey 基础）
└── 会员余额/积分查询
```

技术选型：微信小程序（中国市场）或 Flutter（国际市场）

### 4.4 订阅计费系统

```sql
-- plans 表
plans:
├── id, name, code
├── max_patients      -- 患者上限
├── max_users         -- 员工账号上限
├── max_branches      -- 门店上限
├── features          -- JSON: 功能开关列表
├── price_monthly
├── price_yearly
└── is_trial

-- tenant_subscriptions 表
tenant_subscriptions:
├── tenant_id
├── plan_id
├── status (trial / active / past_due / cancelled)
├── current_period_start
├── current_period_end
└── payment_gateway_subscription_id
```

功能门控：

```php
// 中间件检查
if (!tenant()->canUse('inventory_module')) {
    abort(403, '请升级套餐以使用库存管理功能');
}
```

---

## 阶段五：运营与增长

### 5.1 数据分析增强

| 报表 | 现有 | 需补齐 |
|---|---|---|
| 营收分析 | 日报 ✓ | 周/月/年趋势、同比环比 |
| 医生绩效 | 基础 ✓ | 客单价、复诊转化率、时段效率 |
| 患者画像 | 来源 ✓ | 生命周期价值(LTV)、流失预警 |
| 库存预警 | 无 | 安全库存、消耗趋势、自动补货建议 |
| 经营驾驶舱 | 无 | 管理者首页 Dashboard（关键指标一屏） |

### 5.2 合规与安全

- [ ] 数据加密：患者敏感字段（身份证、手机号）AES 加密存储
- [ ] 操作审计：已有 OperationLog 基础，需补全覆盖面
- [ ] 数据备份：已有 spatie/backup，需配置异地备份策略
- [ ] RBAC 细化：当前 5 角色偏粗，需支持自定义权限组合
- [ ] 隐私合规：GDPR（国际）/ 《个人信息保护法》（中国）
- [ ] 数据导出/删除：患者有权要求导出或删除其个人数据

### 5.3 前端现代化（可选，长期）

```
当前: jQuery + 零散 Vue 2 + 1.4MB app.js

路径 A（渐进式，推荐）:
  - 保留 Blade 服务端渲染
  - 逐页引入 Vue 3 组件（通过 Vite）
  - 替换 jQuery DataTables → Vue DataTable 组件
  - 风险低，可持续推进

路径 B（重写前端）:
  - 前后端分离：Vue 3 / React SPA + API
  - 一步到位但工程量巨大
  - 仅在团队规模足够时考虑

推荐: 路径 A，商业化初期不需要重写前端
```

---

## 实施优先级与依赖关系

```
阶段一 基础设施加固
│
├─ 1.1 Laravel升级 ──────────────────┐
├─ 1.2 测试体系（可并行）            │
├─ 1.3 CI/CD（可并行）               │
└─ 1.4 Docker化（可并行）            │
                                      ▼
阶段二 架构优化 ◄────────────────── 依赖1.1完成
│
├─ 2.1 API层抽离
├─ 2.2 Service层（可并行）
├─ 2.3 队列异步化（可并行）
└─ 2.4 缓存策略（可并行）
          │
          ▼
┌─────────┴──────────┐
▼                    ▼
阶段三 SaaS化     阶段四 商业化功能
│                 │
├─ 3.1 多租户     ├─ 4.1 支付网关
├─ 3.2 域名路由   ├─ 4.2 SMS适配
└─ 3.3 数据隔离   ├─ 4.3 患者端
                   └─ 4.4 订阅计费
          │                │
          └────────┬───────┘
                   ▼
             阶段五 运营增长
             ├─ 5.1 数据分析
             ├─ 5.2 合规安全
             └─ 5.3 前端现代化
```

---

## 商业化定价建议

基于口腔诊所管理 SaaS 市场：

| 版本 | 目标客户 | 核心功能 | 限制 |
|---|---|---|---|
| 免费版 | 个体诊所试用 | 患者 + 预约 + 基础账单 | 1 用户、200 患者 |
| 标准版 | 单店诊所 | 全功能 + 库存 + 报表 | 5 用户、1 门店 |
| 专业版 | 连锁诊所 | 多门店 + 会员 + 绩效 + API | 20 用户、5 门店 |
| 企业版 | 大型连锁/DSO | 自定义域名 + 数据分析 + 专属支持 | 不限 |

**建议首先推出标准版**，项目当前功能已覆盖单店诊所核心需求，阶段一加固完成后即可开始小范围收费试运营，用真实客户反馈驱动后续迭代优先级。
