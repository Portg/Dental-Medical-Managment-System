# 牙科门诊管理系统 — 架构优化与商业化实施路径

## 项目现状评估

> **最后更新：2026-02-15**

| 维度 | 初始现状 | 当前现状 | 风险等级 |
|---|---|---|---|
| 框架版本 | Laravel 5.8（已停止维护） | **Laravel 11.x**（已完成 5.8→6→8→9→10→11 升级） | ~~高危~~ → **已解决** |
| PHP 版本 | 7.2+（8.x 未适配） | **PHP 8.2+**（随 Laravel 11 适配） | ~~高危~~ → **已解决** |
| 前端架构 | jQuery + 零散 Vue 2.5，1.4MB 单文件 app.js | Vue 已清理（从未实际使用），纯 jQuery + Bootstrap + DataTables | 中 |
| 测试覆盖 | 仅 2 个示例文件，接近 0% | **24 套件 205 测试 659 断言**（Phase A/B/C + 12 套 API 端点测试），发现并修复 12 个 bug | ~~高危~~ → **已解决** |
| API 层 | 无独立 API，全部 Web 路由 + AJAX | **API v1 已建立**：Sanctum 认证 + 19 资源 126 端点 RESTful API（患者/预约/发票/病例 + 库存/会员/提成/临床/账单/主数据 + 技工单/技工厂），Web 路由 AJAX 仍保留 | ~~中~~ → **基本完成** |
| 部署 | 无 Docker / CI-CD，手动部署 | **Docker 5 服务已就绪 + GitHub Actions CI 已配置** | ~~中~~ → **已解决** |
| 多租户 | 仅 branch_id 过滤，非真正隔离 | 未变更 | 中 |
| 支付集成 | 自建逻辑，无第三方网关 | 未变更 | 中 |
| SMS | 仅 AfricasTalking（非中国市场） | AfricasTalking 已移除，SMS 框架保留 | 低 |

### 功能模块统计

| 类别 | 数量 |
|---|---|
| 控制器 | 96 个 |
| 数据模型 | 92 个 |
| 数据库表 | 135 张 |
| Blade 视图 | 246 个 |
| 前端 JS 文件 | 36 个 |
| 语言文件 | 70+ 个/语言 |
| 角色模块 | 5 个（Doctor / Nurse / Receptionist / SuperAdmin / Pharmacy） |

### 已有核心功能清单

- **患者管理**：CRUD、病历、影像、标签、随访、过敏/慢性病/手术史
- **预约调度**：日历视图、医生排班、在线预约、候诊排队、牙椅管理
- **病例管理**：SOAP 病历、进展记录、诊断、治疗方案（分阶段）、处方、牙位图
- **账单系统**：发票、报价单、混合支付、退费审批、折扣审批、优惠券
- **会员体系**：会员等级、储值余额、积分、会员交易记录
- **医疗卡**：预付费套餐项目
- **库存管理**：出入库、批次、耗材关联、采购订单
- **人事薪酬**：员工合同、工资条、预支、津贴/扣款、假期审批
- **医生提成**：提成规则、佣金申报、提成支付
- **财务管理**：费用管理、费用分类、会计科目
- **报表**：日收入、医生绩效、欠费、保险理赔、就诊率、项目收入、预算分析
- **通信**：SMS 日志、生日祝福、账单邮件通知
- **系统管理**：角色权限（RBAC）、多门店、审计日志、i18n（中/英）

### 与市场主流产品功能差距分析

> 对标产品：牙医管家、领健·e看牙、CareStack、Dentrix、Open Dental 等主流口腔诊所管理系统。

| 功能模块 | 市场主流 | 本系统现状 | 差距等级 | 优先级 |
|---|---|---|---|---|
| **技工单/义齿加工管理** | 标配：外加工追踪、状态管理、费用核算、技工厂对接 | ✅ 已实现：技工单 CRUD + 状态流转 + 超期预警 + 费用核算 + 技工厂管理 + PDF 打印 + API | ~~高~~ → **已解决** | ~~P0~~ ✅ |
| **营销与 CRM/SCRM** | 标配：患者分级、沉睡唤醒、营销活动、渠道 ROI、微信 SCRM | ❌ 仅有患者标签和来源基础字段，无营销自动化 | **高** | P1 |
| **转诊管理** | 常见：诊所间转诊、专科转诊、转诊来源追踪 | ❌ 完全缺失 | 中 | P2 |
| **患者保险理赔** | 标配（国际）：保险资格验证、理赔提交、EOB 处理、AR 追踪 | ❌ 仅有医生提成理赔，无患者保险理赔流程 | 中 | P1 |
| **知情同意书管理** | 常见：独立同意书模板、电子签名、归档管理 | 🟡 治疗方案中有 `electronic_signature` 字段，无独立同意书管理 | 中 | P1 |
| **数字影像设备集成** | 标配：DICOM 协议、X 光/CBCT/口内相机直连、影像标注 | 🟡 有 `PatientImage` 基础上传（支持 X-Ray/CT/口内/口外分类），无设备直连和 DICOM | 中 | P2 |
| **电子表单/健康问卷** | 常见：初诊表、健康问卷、病史采集数字化 | 🟡 仅有满意度调查问卷，无初诊表/健康问卷 | 中 | P1 |
| **统一消息中心** | 标配：SMS + 邮件 + 站内信 + 微信统一收件箱 | 🟡 SMS 日志和 Laravel 通知已有，无统一消息中心 UI | 中 | P2 |
| **设备维护管理** | 常见：设备台账、维保记录、维保提醒 | 🟡 仅有牙椅（`Chair`）管理，无通用设备维保系统 | 低 | P3 |
| **患者门户/小程序** | 标配：在线预约、病历查看、账单支付、候诊查询 | 🟡 仅有 `OnlineBooking` 基础预约，非完整门户 | **高** | P1 |
| **公告/通知管理** | 常见：诊所内部公告板、通知发布与已读追踪 | 🟡 有 Laravel Notification 表，无专用公告 UI | 低 | P3 |
| **患者教育内容** | 加分项：术前术后指导、口腔保健知识库 | ❌ 完全缺失 | 低 | P3 |
| **员工在线培训** | 加分项：培训课程、考核、学习记录 | ❌ 完全缺失 | 低 | P3 |

#### 关键差距说明

**1. 技工单/义齿加工管理（P0 — 口腔诊所刚需）**

技工单是口腔诊所区别于其他医疗机构的核心业务流程，牙医管家和领健均将其作为核心模块。涉及：

```
lab_cases / 技工单
├── 基础信息：患者、医生、义齿类型、加工单位（技工厂）
├── 工艺信息：材料、颜色、咬合记录、特殊要求
├── 流程追踪：送出 → 制作中 → 返回 → 试戴 → 完成
├── 费用管理：加工费、患者收费、利润计算
├── 时间管理：预计交付日期、实际交付日期、超期预警
└── 质量管理：返工记录、质量评价
```

**2. 营销与 CRM（P1 — 商业化竞争力）**

主流竞品（领健 SCRM、牙医管家营销模块）均提供：

```
营销 CRM
├── 患者生命周期管理：新患 → 初诊 → 在治 → 复诊 → 沉睡 → 流失
├── 智能分群：按消费金额、就诊频次、项目类型自动分层
├── 营销活动：优惠券推送、节日营销、裂变活动
├── 渠道追踪：各渠道获客成本、转化率、ROI 分析
├── 沉睡唤醒：自动识别 N 天未就诊患者，触发提醒
└── 微信集成：服务号模板消息、小程序预约、社交分享
```

**3. 患者保险理赔（P1 — 国际市场必需）**

国际市场（Dentrix、CareStack、Open Dental）标配功能：

```
保险理赔管理
├── 保险资格验证：实时查询患者保险状态与覆盖范围
├── 理赔提交：自动生成 CDT 代码、电子提交理赔单
├── EOB 处理：保险公司回款对账、自动过账
├── AR 追踪：应收账款账龄分析、催收工作流
└── 预授权：术前预审批流程
```

> 注：中国市场医保对接需与当地医保系统接口对接，复杂度高，建议后期按需实施。

---

## 路线图实施进度总览

> **统计截止：2026-02-15** | 基于代码仓库 `upgrade/laravel-10` 分支实际情况

| 阶段 | 子项 | 完成度 | 说明 |
|---|---|---|---|
| **阶段一** 基础设施加固 | 1.1 Laravel 升级 | **✅ 100%** | 已完成 5.8→6→8→9→10→11.x 全部升级 |
|  | 1.2 测试体系 | **✅ 100%** | 23 套件 187 测试 595 断言（Phase A/B/C + API 端点测试），发现并修复 12 个 bug |
|  | 1.3 CI/CD | **✅ 100%** | GitHub Actions 配置完成（PHPUnit + 前端构建，MySQL service container） |
|  | 1.4 Docker 化 | **✅ 100%** | docker-compose 5 服务（app/worker/nginx/mysql/redis）+ Dockerfile + entrypoint + scheduler cron |
| **阶段二** 架构优化 | 2.1 API 层抽离 | **✅ 90%** | 19 资源 API 已完成（21 控制器 + 20 Resource + 126 端点），剩余：限流/文档/版本管理 |
|  | 2.2 Service 层 | **✅ 95%** | 98 个 Service 类已创建，96 个 Controller 已重构为调用 Service |
|  | 2.3 队列异步化 | **✅ 100%** | Redis 队列驱动 + Docker worker 服务 + 3 Job 重试配置 + SendAppointmentSms 序列化 bug 修复 |
|  | 2.4 缓存策略 | **✅ 100%** | Redis 缓存驱动 + 6 个缓存点（权限/医疗服务/门店/保险公司/患者来源/会员等级） |
| **阶段三** SaaS 化 | 3.1 ~ 3.3 | **🔴 0%** | 依赖阶段二完成，尚未启动 |
| **阶段四** 商业化功能 | 4.1 ~ 4.4 | **🔴 0%** | 尚未启动 |
|  | 4.5 技工单管理 (新增) | **✅ 100%** | API 层（2 模型 + 2 Service + 2 API 控制器 + 2 Resource + 15 端点 + 18 测试）+ Web 层（2 Web 控制器 + 7 Blade 视图 + PDF 打印 + 侧边栏菜单）已全部完成 |
|  | 4.6 营销与 CRM (新增) | **🔴 0%** | P1 商业化竞争力 |
|  | 4.7 知情同意书 (新增) | **🔴 0%** | P1 合规需要 |
|  | 4.8 电子表单/问卷 (新增) | **🔴 0%** | P1 减少纸质流程 |
| **阶段五** 运营增长 | 5.1 数据分析 | **🟡 40%** | 已有基础报表和聚合表，高级分析待建设 |
|  | 5.2 合规安全 | **🟡 30%** | 审计日志表已建，RBAC 权限表已建，加密/合规未实施 |
|  | 5.3 前端现代化 | **🔴 0%** | 未启动 |

**整体进度：阶段一全部完成（1.1/1.2/1.3/1.4 ✅），阶段二全部完成（2.1 API 90% / 2.2/2.3/2.4 ✅），阶段三未启动，阶段四 4.5 技工单管理已全部完成（API + Web ✅），阶段五部分推进。**

---

## 阶段一：基础设施加固（商业化前提）

**目标**：消除技术债务，建立工程化基础，使系统具备可交付质量。

### 1.1 Laravel 版本升级路径 — ✅ 100% 完成

```
5.8 → 6.x → 7.x → 8.x → 9.x → 10.x → 11.x
              ↑ 跳过      ✅    ✅    ✅     ✅
```

**已完成的升级步骤：**

| 步骤 | 状态 | 提交记录 |
|---|---|---|
| 5.8 → 6.x | ✅ 已完成 | （合并在 6→8 中） |
| 6.x → 8.x | ✅ 已完成 | `188ee67` upgrade: Laravel 6.x → 8.x |
| Guzzle 升级到 7.x | ✅ 已完成 | `c89e9bb` chore: remove africastalking, upgrade Guzzle |
| 8.x → 9.x | ✅ 已完成 | `bb07ab1` upgrade: Laravel 8.x → 9.x with PHP 8.1 |
| 9.x → 10.x | ✅ 已完成 | `7062d90` upgrade: Laravel 9.x → 10.x |
| TrustProxies 适配 | ✅ 已完成 | `6cca1ea` fix: add HEADER_X_FORWARDED_PREFIX |
| 10.x → 11.x | ✅ 已完成 | 代码适配 + composer 升级 |

逐大版本升级，每一步：

- 用 `laravel-shift`（付费工具）自动化迁移差异
- 重点关注：
  - ~~5.8→6.0：`str_*` / `array_*` 全局 helper 移除~~ ✅
  - ~~7.0：路由缓存变化~~ （跳过 7.x，直接 6→8）
  - ~~8.0：Model Factory 重写、Job Batching~~ ✅
  - ~~9.0：要求 PHP 8.0+~~ ✅
  - ~~10.0：要求 PHP 8.1+~~ ✅
  - ~~11.0：要求 PHP 8.2+，移除多项废弃特性~~ ✅
- 每个版本跑通所有页面后再进入下一版本

**依赖包兼容矩阵**（已完成升级的标注当前版本）：

| 包 | 原始版本 | 当前版本 | 目标版本 | 状态 |
|---|---|---|---|---|
| `maatwebsite/excel` | 2.1 | 3.1 | 3.1+ | ✅ 已完成 |
| `yajra/datatables` | 9.7 | 10.0 | 11.x | 🟡 已升级，可继续 |
| `owen-it/laravel-auditing` | 10.0 | 13.0 | 13.x | ✅ 已完成 |
| `nwidart/laravel-modules` | 6.1 | 10.0 | 11.x | 🟡 已升级，可继续 |
| `maddhatter/laravel-fullcalendar` | 1.3 | 仍在使用 | 需替代方案 | ⬜ 待替换 |
| `jimmyjs/report-generator` | 1.1 | 仍在使用 | 需替代方案 | ⬜ 待替换 |
| `barryvdh/laravel-dompdf` | — | 2.0 | — | ✅ 已适配 |
| `spatie/laravel-backup` | — | 8.0 | — | ✅ 已适配 |

### 1.2 测试体系建设 — ✅ 100% 完成

**当前状态**：Phase A/B/C + API 端点测试全部完成，24 个测试套件，205 测试，659 断言。PHPUnit 10.0 已配置，MySQL 测试数据库 `dental_medical_test`。

**已完成：**
- ✅ `AuthSmokeTest` — 14 测试（Web 登录/登出、Sanctum API 认证、角色权限门控）
- ✅ `PatientCrudSmokeTest` — 9 测试（CRUD + 搜索 + 分页 + 认证守卫）
- ✅ `AppointmentCrudSmokeTest` — 8 测试（CRUD + 改期 + 认证守卫）
- ✅ `InvoiceCrudSmokeTest` — 9 测试（创建 + 列表/详情/删除 + 金额/项目查询 + 挂账 + 认证守卫）
- ✅ `NameHelperTest` — 8 测试（中文姓名拆分/拼接、复姓、locale 切换）
- ✅ `FinancialCalculationTest` — 8 测试（发票金额求和、余额、支付方式分项统计、发票编号递增）
- ✅ `DiscountWorkflowTest` — 7 测试（折扣阈值/审批/拒绝/挂账/canAcceptPayment）
- ✅ `MixedPaymentTest` — 6 测试（混合支付、储值扣减、超额拒绝、会员积分）
- ✅ `RefundWorkflowTest` — 9 测试（退费阈值/审批/拒绝/限额/重复检查/储值退回）
- ✅ `PermissionCacheTest` — 5 测试（5 角色 Dashboard Gate、权限缓存创建/删除失效）
- ✅ `MemberServiceTest` — 6 测试（会员注册/充值/重复注册/非活跃拒绝/等级删除保护）
- ✅ `RegressionTest` — 6 测试（DataTables JSON / PDF / Excel / Job 调度）
- ✅ `InventoryItemApiTest` — 9 测试（库存 CRUD + 搜索 + 低库存预警 + 认证守卫）
- ✅ `MemberApiTest` — 14 测试（会员注册/充值/交易记录 + 等级 CRUD + 认证守卫）
- ✅ `DoctorClaimApiTest` — 7 测试（提成 CRUD + 审批）
- ✅ `TreatmentApiTest` — 7 测试（治疗记录 CRUD + 按预约筛选）
- ✅ `TreatmentPlanApiTest` — 7 测试（治疗方案 CRUD + 患者方案列表）
- ✅ `PrescriptionApiTest` — 8 测试（处方 CRUD + 按预约查询 + 药名补全）
- ✅ `DentalChartApiTest` — 5 测试（牙位图 CRUD + 患者/预约查询）
- ✅ `InvoicePaymentApiTest` — 8 测试（支付 CRUD + 支付方式列表 + 认证守卫）
- ✅ `RefundApiTest` — 8 测试（退费 CRUD + 审批/驳回 + 待审批列表）
- ✅ `QuotationApiTest` — 5 测试（报价单 CRUD）
- ✅ `MasterDataApiTest` — 12 测试（医疗服务 + 供应商 CRUD）
- ✅ `LabCaseApiTest` — 18 测试（技工厂 CRUD + 技工单 CRUD + 状态流转 + 超期/统计/选项 + 认证守卫）
- ✅ 测试过程中发现并修复 12 个 bug（FK 引用、telephone 列名、tooth_no 缺失、status enum、stored_balance→member_balance、MemberTransaction 字段名、Receipt full_name 计算列、DentalChart position→section 列名不匹配、DentalChart kind 列不存在、QuotationItem price→amount 列名不匹配、DoctorClaimService ClaimRate 空指针、InvoicePayment payment_method ENUM 值范围）

按优先级分层建立：

```
Phase A: 冒烟测试                                    ✅ 已完成（40 测试 / 134 断言）
├── 登录/登出/权限拦截                                ✅ AuthSmokeTest
├── 患者 CRUD                                        ✅ PatientCrudSmokeTest
├── 预约 CRUD                                        ✅ AppointmentCrudSmokeTest
└── 发票创建/挂账                                    ✅ InvoiceCrudSmokeTest

Phase B: 核心业务测试                                 ✅ 已完成（49 测试 / ~170 断言）
├── 姓名 i18n（NameHelper 单元测试）                  ✅ NameHelperTest
├── 财务计算（发票金额、余额、支付方式分项）           ✅ FinancialCalculationTest
├── 折扣审批流程                                      ✅ DiscountWorkflowTest
├── 混合支付 + 储值 + 积分                            ✅ MixedPaymentTest
├── 退费审批流程                                      ✅ RefundWorkflowTest
├── 权限矩阵 + 缓存失效                              ✅ PermissionCacheTest
└── 会员服务                                          ✅ MemberServiceTest

Phase C: 回归测试                                     ✅ 已完成（6 测试 / ~15 断言）
├── DataTables JSON 结构验证                          ✅ RegressionTest
├── PDF/Excel 导出                                    ✅ RegressionTest
└── SMS/Email Job 调度（Bus::fake）                   ✅ RegressionTest

Phase D: API 端点测试                                  ✅ 已完成（108 测试 / 342 断言）
├── 库存管理 API                                      ✅ InventoryItemApiTest
├── 会员 + 等级 API                                   ✅ MemberApiTest
├── 医生提成 API                                      ✅ DoctorClaimApiTest
├── 治疗记录 API                                      ✅ TreatmentApiTest
├── 治疗方案 API                                      ✅ TreatmentPlanApiTest
├── 处方 API                                          ✅ PrescriptionApiTest
├── 牙位图 API                                        ✅ DentalChartApiTest
├── 支付 API                                          ✅ InvoicePaymentApiTest
├── 退费 API                                          ✅ RefundApiTest
├── 报价单 API                                        ✅ QuotationApiTest
├── 主数据（医疗服务 + 供应商）API                     ✅ MasterDataApiTest
└── 技工单 + 技工厂 API                                ✅ LabCaseApiTest
```

### 1.3 CI/CD 管线 — ✅ 100% 完成

**已完成：**
- ✅ `.github/workflows/ci.yml` — GitHub Actions CI 管线
- ✅ **test** job：PHP 8.2 + MySQL 8.0 service container，Composer 缓存，migrations + `php artisan test`
- ✅ **build** job：Node.js 16 + `npm ci` + `npm run production`
- ✅ 触发条件：push 到 `master` / `upgrade/laravel-10`，PR 到 `master`

**待完成：**
- ⬜ lint job（PHP-CS-Fixer + ESLint）
- ⬜ deploy job（仅 master 合并后触发）

### 1.4 Docker 化 — ✅ 100% 完成

**已完成：**
- ✅ `docker-compose.yml` — 5 服务编排
- ✅ `docker/php/Dockerfile` — PHP 8.2-FPM，含 Redis 扩展、Composer、cron 配置
- ✅ `docker/php/entrypoint.sh` — `CONTAINER_ROLE` 分流（app / worker / scheduler）
- ✅ `docker/nginx/default.conf` — Nginx 配置
- ✅ `docker/mysql/init.sql` — 数据库初始化
- ✅ `.env.docker` — Docker 环境变量（MySQL/Redis 连接）
- ✅ `.dockerignore` — 排除不需要的文件

**服务清单：**

```
docker-compose.yml
├── app        (PHP-FPM + Laravel + cron scheduler)
├── worker     (队列消费者, restart: unless-stopped)
├── nginx      (Web 服务器, port 80)
├── mysql      (MySQL 8.0, healthcheck, 持久化 volume)
└── redis      (Redis 7-alpine, 持久化 volume)
```

---

## 阶段二：架构优化（可扩展性） — ✅ 基本完成

> **前置依赖**：阶段 1.1 Laravel 升级已完成（11.x），Service 层、API 层、队列、缓存全部完成。

### 2.1 API 层抽离 — ✅ 90% 完成

**当前状态**：19 个资源 API 已完成，126 个端点已注册，21 个控制器 + 20 个 Resource，108 个 API 端点测试全部通过。

**已完成：**
- ✅ `routes/api/v1.php` — API v1 路由文件，126 个端点，通过 `RouteServiceProvider::mapApiV1Routes()` 注册
- ✅ `App\Http\Controllers\Api\V1\ApiController` — API 基础控制器，统一响应格式 `{success, data, message, meta?}`
- ✅ `App\Http\Controllers\Api\V1\AuthController` — Sanctum 认证（login / logout / me）
- ✅ `App\Http\Controllers\Api\V1\PatientController` — 患者 CRUD + 搜索 + 病历
- ✅ `App\Http\Controllers\Api\V1\AppointmentController` — 预约 CRUD + 日历事件 + 医生时段
- ✅ `App\Http\Controllers\Api\V1\InvoiceController` — 发票 CRUD + 折扣审批 + 赊账
- ✅ `App\Http\Controllers\Api\V1\MedicalCaseController` — 病例 CRUD + ICD10 搜索
- ✅ `App\Http\Controllers\Api\V1\InventoryItemController` — 库存 CRUD + 搜索 + 低库存/过期预警（8 端点）
- ✅ `App\Http\Controllers\Api\V1\MemberController` — 会员注册/充值/交易记录（6 端点）
- ✅ `App\Http\Controllers\Api\V1\MemberLevelController` — 会员等级 CRUD（5 端点）
- ✅ `App\Http\Controllers\Api\V1\DoctorClaimController` — 医生提成 CRUD + 审批（6 端点）
- ✅ `App\Http\Controllers\Api\V1\TreatmentController` — 治疗记录 CRUD + 筛选（5 端点）
- ✅ `App\Http\Controllers\Api\V1\TreatmentPlanController` — 治疗方案 CRUD + 患者方案（6 端点）
- ✅ `App\Http\Controllers\Api\V1\PrescriptionController` — 处方 CRUD + 预约查询 + 药名补全（7 端点）
- ✅ `App\Http\Controllers\Api\V1\DentalChartController` — 牙位图 CRUD + 患者/预约查询（4 端点）
- ✅ `App\Http\Controllers\Api\V1\InvoicePaymentController` — 支付 CRUD + 混合支付 + 支付方式列表（7 端点）
- ✅ `App\Http\Controllers\Api\V1\RefundController` — 退费 CRUD + 审批/驳回 + 待审批列表（7 端点）
- ✅ `App\Http\Controllers\Api\V1\QuotationController` — 报价单 CRUD（4 端点）
- ✅ `App\Http\Controllers\Api\V1\MedicalServiceController` — 医疗服务 CRUD（5 端点）
- ✅ `App\Http\Controllers\Api\V1\SupplierController` — 供应商 CRUD（5 端点）
- ✅ `App\Http\Controllers\Api\V1\LabController` — 技工厂 CRUD（5 端点）
- ✅ `App\Http\Controllers\Api\V1\LabCaseController` — 技工单 CRUD + 状态流转 + 超期/统计/选项（10 端点）
- ✅ 20 个 ApiResource（PatientResource、AppointmentResource、InvoiceResource、MedicalCaseResource + 16 个新增）
- ✅ `config/sanctum.php` + `laravel/sanctum` v4.3.0
- ✅ `personal_access_tokens` 迁移文件
- ✅ 108 个 API 端点测试（12 个测试文件，342 断言），全部通过

**测试中发现并修复的 DB 模型 bug：**
- `DentalChart` 模型 `$fillable` 中 `position` 实际 DB 列名为 `section`，`kind` 和 `patient_id` 列不存在
- `QuotationItem` 模型 `$fillable` 中 `price` 实际 DB 列名为 `amount`，`tooth_no` 列不存在
- `DoctorClaimService::insuranceClaim()` / `cashClaim()` 未处理 `ClaimRate` 为 null 的情况
- `invoice_payments.payment_method` 为 ENUM 类型，仅支持 `Cash/Online Wallet/Insurance/Mobile Money/Cheque`，Service 层定义的 WeChat/Alipay 等未在 DB ENUM 中

**待完成：**
- ⬜ API 版本管理中间件
- ⬜ API 限流（throttle）配置
- ⬜ API 文档（Swagger/OpenAPI）
- ⬜ `invoice_payments.payment_method` ENUM 扩充（添加 WeChat/Alipay/BankCard/StoredValue 等）

```
routes/
├── web.php     → 页面渲染 + 现有 AJAX（保留）
├── api/v1.php  → RESTful JSON API ✅ 111 端点已注册
│   ├── /api/v1/auth               ✅ 认证（3 端点）
│   ├── /api/v1/patients           ✅ 患者（8 端点）
│   ├── /api/v1/appointments       ✅ 预约（9 端点）
│   ├── /api/v1/invoices           ✅ 发票（9 端点）
│   ├── /api/v1/medical-cases      ✅ 病例（7 端点）
│   ├── /api/v1/inventory-items    ✅ 库存（8 端点）
│   ├── /api/v1/members            ✅ 会员（6 端点）
│   ├── /api/v1/member-levels      ✅ 会员等级（5 端点）
│   ├── /api/v1/doctor-claims      ✅ 医生提成（6 端点）
│   ├── /api/v1/treatments         ✅ 治疗记录（5 端点）
│   ├── /api/v1/treatment-plans    ✅ 治疗方案（6 端点）
│   ├── /api/v1/prescriptions      ✅ 处方（7 端点）
│   ├── /api/v1/dental-charts      ✅ 牙位图（4 端点）
│   ├── /api/v1/invoice-payments   ✅ 支付（7 端点）
│   ├── /api/v1/refunds            ✅ 退费（7 端点）
│   ├── /api/v1/quotations         ✅ 报价单（4 端点）
│   ├── /api/v1/medical-services   ✅ 医疗服务（5 端点）
│   ├── /api/v1/suppliers          ✅ 供应商（5 端点）
│   ├── /api/v1/labs               ✅ 技工厂（5 端点）
│   └── /api/v1/lab-cases          ✅ 技工单（10 端点）
└── api/v1 认证 → Laravel Sanctum ✅
```

### 2.2 Service 层引入 — ✅ 95% 完成

**当前状态**：98 个 Service 类已创建于 `App/Services/` 目录，96 个 Controller 已重构为调用 Service 层。

**已完成：**
- ✅ 98 个 Service 类覆盖全部业务模块（患者、预约、发票、退费、会员、库存、医生提成、报表等）
- ✅ 96 个 Controller 已重构，业务逻辑从 Controller 迁入 Service
- ✅ 模块 Controller（Doctor/Nurse/Receptionist/SuperAdmin/Pharmacy）同步重构

**Service 目录结构（部分）：**

```
App/Services/
├── PatientService.php          ✅
├── AppointmentService.php      ✅
├── InvoiceService.php          ✅
├── RefundService.php           ✅
├── MemberService.php           ✅
├── DentalChartService.php      ✅
├── InventoryItemService.php    ✅
├── DoctorClaimService.php      ✅
├── ...（共 98 个）
├── SuperAdminDashboardService.php  ✅
├── DoctorDashboardService.php      ✅
└── ReceptionistDashboardService.php ✅
```

**待完成：**
- ⬜ Service 层单元测试
- ⬜ 复杂 Service 拆分（如有必要）

### 2.3 队列异步化 — ✅ 100% 完成

**已完成：**
- ✅ `.env.docker` 切换 `QUEUE_CONNECTION=redis`
- ✅ `docker-compose.yml` 新增 `worker` 服务（复用 PHP Dockerfile，`restart: unless-stopped`）
- ✅ `docker/php/entrypoint.sh` 支持 `CONTAINER_ROLE` 分流（app/worker/scheduler）
- ✅ `app/Console/Kernel.php` 添加 `queue:restart` 每小时调度，配合 worker `--max-time=3600`
- ✅ `SendAppointmentSms` 修复序列化 bug（`SmsLogger` 实例从构造函数移入 `handle()`），添加 `$tries=3, $backoff=10`
- ✅ `ShareEmailInvoice` / `ShareEmailQuotation` 添加 `$tries=3, $backoff=30, $timeout=60`

**未包含（当前阶段）：** Excel 导出异步化（需前端通知机制）、PDF 生成异步化（即时下载场景）、审计日志异步化（OperationLog 尚未集成）

### 2.4 缓存策略 — ✅ 100% 完成

**已完成：**
- ✅ `.env.docker` 切换 `CACHE_DRIVER=redis`
- ✅ `app/Role.php` — `hasPermission()` 缓存角色权限 slugs（`Cache::remember`），后续检查走 `in_array()`
- ✅ `App/Services/RolePermissionService.php` — 增/改/删操作清除 `role:{id}:permissions` 缓存
- ✅ `App/Services/MedicalServiceService.php` — `getAllServiceNames()` 缓存 + 写操作清除
- ✅ `App/Services/BranchService.php` — 新增 `getAllBranches()` 缓存方法 + 写操作清除
- ✅ `App/Services/InsuranceCompanyService.php` — 新增 `getAllCompanies()` 缓存方法 + 写操作清除
- ✅ `App/Services/PatientSourceService.php` — `getActiveSourcesForSelect(null)` 缓存 + 写操作清除
- ✅ `App/Services/MemberService.php` — `getLevelList()` 缓存 + 写操作清除

**缓存策略汇总：**

| 缓存 Key | TTL | 失效触发 |
|-----------|-----|----------|
| `role:{id}:permissions` | 1h | RolePermissionService 增/改/删 |
| `medical_services:names` | 6h | MedicalServiceService 增/改/删 |
| `branches:all` | 6h | BranchService 增/改/删 |
| `insurance_companies:all` | 24h | InsuranceCompanyService 增/改/删 |
| `patient_sources:active` | 6h | PatientSourceService 增/改/删 |
| `member_levels:all` | 24h | MemberService 增/改/删 |

**未包含（当前阶段）：** Dashboard 计数缓存、DataTables 动态查询缓存、SESSION_DRIVER 切换

---

## 阶段三：多租户 SaaS 化 — 🔴 未启动

> **前置依赖**：依赖阶段二架构优化完成。阶段二已基本完成（Service 层 ✅ / API 层 ✅ 90% / 队列 ✅ / 缓存 ✅），前置依赖已满足，可启动。

### 3.1 多租户隔离方案

当前仅有 `branch_id` 字段，适合单诊所多门店。SaaS 化需要诊所级别隔离。

**推荐方案：共享数据库 + tenant_id 行级隔离**

```
理由：
- 现有 135 张表，独立数据库方案迁移成本过高
- 行级隔离 + Global Scope 足够满足中小诊所场景
- 使用 stancl/tenancy 包或自建 Global Scope

实施：
1. 新增 tenants 表（诊所主体）
2. 所有业务表添加 tenant_id 字段
3. 添加 TenantScope（Global Scope），自动注入 where tenant_id = ?
4. 中间件从域名/子域名解析 tenant
5. 迁移脚本：现有数据统一分配到 tenant_id = 1
```

### 3.2 域名与路由

```
方案 A（子域名）: clinic-a.yourdomain.com
方案 B（路径前缀）: yourdomain.com/clinic-a/
方案 C（自定义域名）: clinic-a-own-domain.com → 需 SSL 自动化

推荐：先 A，后期支持 C（商业价值高）
```

### 3.3 数据隔离验证清单

- [ ] 患者数据：仅本诊所可见
- [ ] 预约/病例：跨诊所不可访问
- [ ] 财务数据：发票/退费严格隔离
- [ ] 员工数据：可属于多诊所（多对多）
- [ ] 系统配置：诊所级别独立配置
- [ ] 报表数据：仅统计本诊所
- [ ] 审计日志：带 tenant_id

---

## 阶段四：商业化功能补齐 — 🔴 未启动

> **前置依赖**：依赖阶段二 API 层和 Service 层完成。Service 层已就绪（95%），API 层已完成（90%），队列 + 缓存已完成，前置依赖已满足，可启动。

### 4.1 支付网关集成

| 市场 | 网关 | 优先级 |
|---|---|---|
| 中国 | 微信支付 + 支付宝 | P0 |
| 国际 | Stripe | P1 |
| 东南亚 | GrabPay / OVO | P2 |

```php
// 抽象支付接口
interface PaymentGateway {
    public function charge(float $amount, array $options): PaymentResult;
    public function refund(string $transactionId, float $amount): RefundResult;
    public function queryStatus(string $transactionId): TransactionStatus;
}

// 实现
App\Services\Payment\
├── PaymentGatewayFactory.php
├── WechatPayGateway.php
├── AlipayGateway.php
├── StripeGateway.php
└── CashGateway.php（现有现金逻辑迁入）
```

### 4.2 SMS 通道适配

AfricasTalking 已移除，SMS 框架保留。中国市场需要：

| 通道 | 用途 |
|---|---|
| 阿里云短信 | 预约提醒、验证码 |
| 腾讯云短信 | 备用通道 |
| 微信模板消息 | 预约确认、报告通知 |

同样抽象为 `SmsChannel` 接口 + 工厂模式。

### 4.3 患者端小程序/H5

基于阶段二的 API 层：

```
患者端功能:
├── 在线预约（已有 OnlineBooking 基础）
├── 候诊排队查看
├── 电子病历查看
├── 账单支付
├── 满意度评价（已有 SatisfactionSurvey 基础）
└── 会员余额/积分查询
```

技术选型：微信小程序（中国市场）或 Flutter（国际市场）

### 4.5 技工单/义齿加工管理 — ✅ 100% 完成

> **市场差距分析中识别的 P0 缺失功能**，口腔诊所核心业务流程。
>
> **已完成**：
> - **数据层**：`labs` + `lab_cases` 表迁移、Lab / LabCase Model、LabService / LabCaseService
> - **API 层**：2 个 API Controller（15 端点）、2 个 API Resource、18 个 API 测试全部通过
> - **Web 层**：2 个 Web Controller（LabCaseController + LabController）、7 个 Blade 视图（列表/详情/创建/编辑/状态更新模态框）、PDF 打印模板、SuperAdmin 侧边栏菜单集成
> - **Bug 修复**：DataTables `search` 参数 Array to string conversion（DataTables 传入 `search[value]`/`search[regex]` 数组，需提取 `search.value` 字符串）
> - **i18n**：zh-CN + en 语言文件（`lab_cases.php` + `labs.php` + `menu.php` 更新）

```
数据模型:
lab_cases（技工单）
├── lab_case_no          -- 技工单编号
├── patient_id, doctor_id, appointment_id, medical_case_id
├── lab_id               -- 关联技工厂
├── prosthesis_type      -- 义齿类型（冠、桥、活动义齿、种植体等）
├── material             -- 材料（氧化锆、金属烤瓷、全瓷等）
├── color_shade          -- 比色信息
├── teeth_positions      -- 牙位（JSON）
├── special_requirements -- 特殊工艺要求
├── status               -- 待送出/制作中/已返回/试戴/完成/返工
├── sent_date, expected_return_date, actual_return_date
├── lab_fee, patient_charge
└── quality_rating, rework_count, rework_reason

labs（技工厂）
├── name, contact, phone, address
├── specialties          -- 擅长类型
└── avg_turnaround_days  -- 平均交付天数
```

**核心功能**：
- 技工单 CRUD，关联患者/医生/病例
- 技工厂管理（供应商子类型）
- 状态流转追踪与超期预警
- 费用核算（加工成本 vs 患者收费）
- 返工/质量追踪
- 技工单打印

### 4.6 营销与 CRM — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**，商业化核心竞争力。

```
Phase A: 基础 CRM（优先）
├── 患者生命周期标签：新患/初诊/在治/复诊/沉睡/流失（基于就诊记录自动计算）
├── 沉睡患者识别：N 天未就诊自动标记，支持批量提醒
├── 营销活动管理：活动创建、目标人群、效果追踪
└── 渠道 ROI 分析：基于现有 patient_sources 数据增强

Phase B: 高级 SCRM（后期）
├── 微信服务号集成：模板消息推送
├── 小程序营销：拼团、裂变、分享有礼
├── 智能推荐：基于历史治疗推荐后续项目
└── 患者画像看板：消费力、忠诚度、价值分层可视化
```

### 4.7 知情同意书管理 — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**。

```
consent_templates（同意书模板）
├── template_name, template_type（手术/麻醉/影像/通用）
├── content              -- 富文本内容
├── required_for_services -- 关联的医疗服务项目（JSON）
└── version, is_active

patient_consents（患者签署记录）
├── patient_id, template_id, medical_case_id
├── signed_at, signature_image
├── witness_name, doctor_id
└── pdf_path             -- 存档 PDF
```

### 4.8 电子表单/健康问卷 — 🔴 未开始（新增）

> **市场差距分析中识别的 P1 缺失功能**。初诊信息采集数字化，减少纸质表单。

```
form_templates（表单模板）
├── name, type（初诊表/健康问卷/儿童问卷/术前评估）
├── fields              -- JSON Schema 定义表单字段
└── is_active, version

form_submissions（患者提交）
├── patient_id, template_id
├── data                -- JSON 提交数据
├── submitted_at, submitted_via（现场iPad/在线/小程序）
└── reviewed_by, reviewed_at
```

### 4.4 订阅计费系统

```sql
-- plans 表
plans:
├── id, name, code
├── max_patients      -- 患者上限
├── max_users         -- 员工账号上限
├── max_branches      -- 门店上限
├── features          -- JSON: 功能开关列表
├── price_monthly
├── price_yearly
└── is_trial

-- tenant_subscriptions 表
tenant_subscriptions:
├── tenant_id
├── plan_id
├── status (trial / active / past_due / cancelled)
├── current_period_start
├── current_period_end
└── payment_gateway_subscription_id
```

功能门控：

```php
// 中间件检查
if (!tenant()->canUse('inventory_module')) {
    abort(403, '请升级套餐以使用库存管理功能');
}
```

---

## 阶段五：运营与增长 — 🟡 部分推进

### 5.1 数据分析增强 — 🟡 40% 完成

**已完成的基础设施**：
- ✅ `daily_reports`、`monthly_reports` 聚合表已建立（migration 2026-01-17）
- ✅ `patient_analytics`、`doctor_performance` 分析表已建立
- ✅ 7 个报表控制器已实现（日收入、医生绩效、保险、项目收入、预算、欠费、就诊率）
- ✅ 6 个图表类已实现（月度现金流、患者趋势、费用分析、收入趋势等）
- ✅ 所有报表支持 Excel 导出
- ⬜ 高级分析（同比环比、LTV、流失预警）未实现
- ⬜ 经营驾驶舱未实现

| 报表 | 现有 | 需补齐 | 当前状态 |
|---|---|---|---|
| 营收分析 | 日报 ✓ | 周/月/年趋势、同比环比 | 🟡 基础已有 |
| 医生绩效 | 基础 ✓ | 客单价、复诊转化率、时段效率 | 🟡 基础已有 |
| 患者画像 | 来源 ✓ | 生命周期价值(LTV)、流失预警 | 🟡 基础已有 |
| 库存预警 | ~~无~~ 已有 | 安全库存、消耗趋势、自动补货建议 | 🟡 低库存/过期预警已实现 |
| 经营驾驶舱 | 无 | 管理者首页 Dashboard（关键指标一屏） | 🔴 未开始 |

### 5.2 合规与安全 — 🟡 30% 完成

**已完成的基础设施**：
- ✅ 审计日志表已建立：`login_logs`、`operation_logs`、`access_logs`、`exception_logs`（migration 2026-01-17）
- ✅ `owen-it/laravel-auditing` v13.0 已集成，`audits` 表已建立
- ✅ RBAC 权限系统已建立：`permissions`、`role_permissions` 表（migration 2025-11-16），支持数据库驱动的动态权限
- ✅ `spatie/laravel-backup` v8.0 已集成
- ⬜ 以下项目尚未实施

- [ ] 数据加密：患者敏感字段（身份证、手机号）AES 加密存储
- [x] 操作审计：~~已有 OperationLog 基础，需补全覆盖面~~ 四类审计日志表已建立（login/operation/access/exception），`laravel-auditing` 包已集成
- [x] 数据备份：`spatie/laravel-backup` v8.0 已集成，需配置异地备份策略
- [x] RBAC 细化：~~当前 5 角色偏粗~~ 已建立 `permissions` + `role_permissions` 表，支持自定义权限组合（`AuthServiceProvider` 中动态注册）
- [ ] 隐私合规：GDPR（国际）/ 《个人信息保护法》（中国）
- [ ] 数据导出/删除：患者有权要求导出或删除其个人数据

### 5.3 前端现代化（可选，长期） — 🔴 未开始

```
当前: 纯 jQuery + Bootstrap + DataTables（Vue 2.5 从未实际使用，已清理）

路径 A（渐进式，推荐）:
  - 保留 Blade 服务端渲染
  - 逐页引入 Vue 3 组件（通过 Vite）
  - 替换 jQuery DataTables → Vue DataTable 组件
  - 风险低，可持续推进

路径 B（重写前端）:
  - 前后端分离：Vue 3 / React SPA + API
  - 一步到位但工程量巨大
  - 仅在团队规模足够时考虑

推荐: 路径 A，商业化初期不需要重写前端
```

---

## 实施优先级与依赖关系

```
阶段一 基础设施加固                            状态
│
├─ 1.1 Laravel升级 ──────────────────┐        ✅ 100%（5.8→11.x 全部完成）
├─ 1.2 测试体系（可并行）            │        ✅ 100%（Phase A/B/C 全部完成）
├─ 1.3 CI/CD（可并行）               │        ✅ 100%（GitHub Actions test+build）
└─ 1.4 Docker化（可并行）            │        ✅ 100%（5服务 + entrypoint）
                                      ▼
阶段二 架构优化 ◄────────────────── 依赖1.1完成（✅ 已满足）
│
├─ 2.1 API层抽离                              ✅ 90%（17资源 111端点 90测试）
├─ 2.2 Service层（可并行）                    ✅ 95%（98个Service已创建）
├─ 2.3 队列异步化（可并行）                   ✅ 100%
└─ 2.4 缓存策略（可并行）                     ✅ 100%（Redis + 6缓存点）
          │
          ▼
┌─────────┴──────────┐
▼                    ▼
阶段三 SaaS化     阶段四 商业化功能            ✅ 4.5 已完成
│                 │
├─ 3.1 多租户     ├─ 4.1 支付网关
├─ 3.2 域名路由   ├─ 4.2 SMS适配
└─ 3.3 数据隔离   ├─ 4.3 患者端
                   ├─ 4.4 订阅计费
                   ├─ 4.5 技工单管理 ←── ✅ 100%完成(API+Web)
                   ├─ 4.6 营销CRM   ←── 新增(P1)
                   ├─ 4.7 知情同意书 ←── 新增(P1)
                   └─ 4.8 电子表单   ←── 新增(P1)
          │                │
          └────────┬───────┘
                   ▼
             阶段五 运营增长                   🟡 部分推进
             ├─ 5.1 数据分析                   🟡 40%
             ├─ 5.2 合规安全                   🟡 30%
             └─ 5.3 前端现代化                 🔴 0%
```

**关键路径分析**：阶段一全部完成 ✅，阶段二基本完成 ✅（仅 API 文档/限流/版本管理等运维项待完善），4.5 技工单管理已全部完成 ✅。当前已无阻塞性前置依赖，建议继续推进阶段四商业化功能：4.7+4.8 知情同意书+电子表单（P1 合规+效率）→ 4.6 营销 CRM（P1 商业化竞争力）。

---

## 商业化定价建议

基于口腔诊所管理 SaaS 市场：

| 版本 | 目标客户 | 核心功能 | 限制 |
|---|---|---|---|
| 免费版 | 个体诊所试用 | 患者 + 预约 + 基础账单 | 1 用户、200 患者 |
| 标准版 | 单店诊所 | 全功能 + 库存 + 报表 | 5 用户、1 门店 |
| 专业版 | 连锁诊所 | 多门店 + 会员 + 绩效 + API | 20 用户、5 门店 |
| 企业版 | 大型连锁/DSO | 自定义域名 + 数据分析 + 专属支持 | 不限 |

**建议首先推出标准版**，项目当前功能已覆盖单店诊所核心需求，阶段一加固完成后即可开始小范围收费试运营，用真实客户反馈驱动后续迭代优先级。

---

## 下一步优先行动建议

基于当前进度和市场差距分析，建议按以下优先级推进：

**已完成：**

1. ~~**完成 Laravel 10→11 升级**（1.1 收尾）~~ ✅ 已完成
2. ~~**引入 Service 层**（2.2）~~ ✅ 95% 完成 — 98 个 Service 类已创建，96 个 Controller 已重构
3. ~~**API 层核心建设**（2.1 核心）~~ 🟡 60% 完成 — 4 核心资源 API + Sanctum 认证已就绪
4. ~~**建立冒烟测试**（1.2 Phase A）~~ ✅ 已完成 — 4 套件 40 测试 134 断言，发现并修复 4 个预存 bug
5. ~~**配置 CI/CD**（1.3）~~ ✅ 已完成 — GitHub Actions test + build 两个 job，MySQL service container
6. ~~**队列异步化**（2.3）~~ ✅ 已完成 — Redis 队列 + Docker worker + 3 Job 重试配置
7. ~~**Docker 化**（1.4）~~ ✅ 已完成 — 5 服务编排（app/worker/nginx/mysql/redis）+ scheduler cron
8. ~~**缓存策略**（2.4）~~ ✅ 已完成 — Redis 缓存 + 6 个缓存点（权限/医疗服务/门店/保险/来源/会员等级）

**基础设施完善（可选推进）：**

9. ~~**测试体系 Phase B/C**（1.2 剩余）~~ ✅ 已完成 — 8 套件 57 测试 183 断言，发现并修复 4 个 Service 层 bug
10. ~~**扩展 API 端点**（2.1 剩余）~~ ✅ 已完成 — 13 资源 API 新增（19 控制器 18 Resource 111 端点 90 测试），发现并修复 4 个 DB 模型 bug

**API 运维完善（可选）：**

11. **API 限流 + 版本管理 + 文档**（2.1 收尾）— throttle 中间件、API 版本头、Swagger/OpenAPI 文档生成

**功能补齐（可并行，Service 层 + API 层已就绪）：**

12. ~~**技工单管理**（4.5 新增 P0）~~ ✅ 已完成 — API 层（15 端点 + 18 测试）+ Web 层（2 控制器 + 7 视图 + PDF 打印 + 侧边栏菜单）
13. **知情同意书 + 电子表单**（4.7 + 4.8 新增 P1）— 合规需要且开发量适中，可快速见效
14. **营销 CRM 基础**（4.6 新增 P1）— 先实现患者生命周期标签和沉睡唤醒，利用现有 patient_sources / patient_tags 数据

**SaaS 化（前置依赖已满足）：**

15. **多租户隔离方案**（3.1）— 共享数据库 + tenant_id 行级隔离，阶段一二已完成可启动

---

## 参考资料

- [牙医管家官网](https://www.dentalink.com.cn/) — 国内市占率最高的口腔诊所 SaaS
- [领健·e看牙官网](https://www.linkedcare.cn/kouqiang) — PMS + EMR + CRM + SCRM 一体化方案
- [CareStack](https://carestack.com/) — 国际市场全功能云端牙科管理系统
- [Top Features of Dental Practice Management Software 2025](https://adit.com/top-features-dental-practice-management-software-2025)
- [Top 10 Dental Practice Management Software 2026](https://www.certifyhealth.com/blog/top-10-dental-practice-management-software-2026/)
- [What Is Dental Practice Management Software](https://www.oryxdental.com/what-is-dental-practice-management-software/)
- [Top 11 Features to Look for in Dental PMS](https://mconsent.net/blog/features-dental-practice-management-software/)
- [口腔诊所管理系统最全分析](https://www.jiushuyun.com/blog/yy/25256.html)
