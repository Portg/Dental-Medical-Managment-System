# 牙科门诊管理系统 — 架构优化与落地实施路径

> **适配市场**：中国大陆口腔门诊 / 小型连锁（1-3 店）

## 项目现状评估

> **最后更新：2026-02-24**

| 维度 | 初始现状 | 当前现状 | 状态 |
|---|---|---|---|
| 框架版本 | Laravel 5.8（已停止维护） | **Laravel 11.x**（已完成 5.8→6→8→9→10→11 升级） | **已解决** |
| PHP 版本 | 7.2+（8.x 未适配） | **PHP 8.2+**（随 Laravel 11 适配） | **已解决** |
| 前端架构 | jQuery + 零散 Vue 2.5，1.4MB 单文件 app.js | Vue 已清理，纯 jQuery + Bootstrap + DataTables | 稳定 |
| 测试覆盖 | 仅 2 个示例文件，接近 0% | **29 套件 220+ 测试**，发现并修复 15+ 个 bug | **已解决** |
| API 层 | 无独立 API，全部 Web 路由 + AJAX | **API v1 已完成**：Sanctum 认证 + 19 资源 126 端点 + 限流 + OpenAPI 文档 | **已完成** |
| 部署 | 无 Docker / CI-CD，手动部署 | **Docker 5 服务已就绪 + GitHub Actions CI + Laragon Windows 安装包** | **已解决** |
| 模块架构 | nwidart/laravel-modules 5 模块 | **已迁移至 app 层**：Modules/ 目录已删除 | **已解决** |
| 菜单系统 | 硬编码 Blade 侧边栏 | **动态菜单系统**：MenuItem 模型 + 角色权限过滤 + CRUD 管理 | **已解决** |
| 数据安全 | 无加密、无脱敏 | **NIN 加密 + 展示脱敏 + 揭示审计 + 导出脱敏 + 密码策略** | **大部分完成** |

### 功能模块统计

| 类别 | 数量 |
|---|---|
| 控制器 | 105+ 个（含 12 个报表控制器、7 个模块迁移控制器） |
| 数据模型 | 93 个（新增 MenuItem、MedicalCaseAmendment） |
| Service 类 | 105+ 个 |
| 数据库表 | 138 张（新增 menu_items、role_menu_items、medical_case_amendments） |
| Blade 视图 | 260+ 个（新增报表/菜单管理/角色 Tab/动态侧边栏等） |
| 前端 JS 文件 | 36 个 |
| 语言文件 | 70+ 个/语言 |
| 架构 | 单体 app 层（原 nwidart/laravel-modules 5 模块已迁入 app 级别） |

### 已有核心功能清单

- **患者管理**：CRUD、病历、影像、标签、随访、过敏/慢性病/手术史
- **预约调度**：日历视图、医生排班、在线预约、候诊排队、牙椅管理
- **病例管理**：SOAP 病历、进展记录、诊断、治疗方案（分阶段）、处方、牙位图
- **账单系统**：发票、报价单、混合支付、退费审批、折扣审批、优惠券
- **会员体系**：会员等级、储值余额、积分、会员交易记录
- **医疗卡**：预付费套餐项目
- **库存管理**：出入库、批次、耗材关联、采购订单
- **人事薪酬**：员工合同、工资条、预支、津贴/扣款、假期审批
- **医生提成**：提成规则、佣金申报、提成支付
- **财务管理**：费用管理、费用分类、会计科目
- **报表**：日收入、医生绩效、欠费、就诊率、项目收入、预约分析、月度总览、患者画像等 12 个
- **系统管理**：角色权限（RBAC）、动态菜单、审计日志、i18n（中/英）、系统维护

### 与市场主流产品功能差距分析

> 对标产品：牙医管家、领健·e看牙 等主流口腔诊所管理系统。
> **注意**：以下仅列出本系统可独立实现的功能差距，不含需要政府审批、第三方资质或大规模投入的外部对接类功能。

| 功能模块 | 市场现状 | 本系统 | 差距 | 优先级 |
|---|---|---|---|---|
| **技工单管理** | 标配 | ✅ 全流程已实现 | **已解决** | ✅ |
| **器械消毒追溯** | 监管检查重点 | ❌ 完全缺失 | **高** | P1 |
| **收费合规/价格管理** | 监管要求 | 🟡 仅有折扣审批 | **高** | P1 |
| **知情同意书管理** | 合规常见要求 | 🟡 仅有签名字段，无独立管理 | 中 | P1 |
| **电子表单/健康问卷** | 减少纸质流程 | 🟡 仅有满意度调查 | 中 | P1 |
| **患者召回提醒** | 运营刚需 | 🟡 有 SMS 日志框架，无自动召回 | 中 | P1 |
| **短信通道（国内）** | 标配 | 🟡 AfricasTalking 已移除，框架保留 | 中 | P1 |
| **经营驾驶舱** | 管理者刚需 | 🟡 有 12 个报表，无一屏总览 | 中 | P2 |
| **数字影像管理** | 常见 | 🟡 有基础上传，无 DICOM/标注 | 低 | P3 |

### 已移除的路线图项（含移除原因）

以下功能在之前版本的路线图中列为 P0/P1，经过对中国口腔门诊实际经营情况的评估后移除：

| 原路线图项 | 原优先级 | 移除原因 |
|---|---|---|
| **医保系统对接** | ~~P0~~ | 中国口腔诊疗 **90% 以上为自费项目**（种植 8000-30000/颗、正畸 15000-50000、烤瓷冠 2000-8000）。医保仅覆盖拔牙(~200)、基础补牙(~300)等低价值项目，且通过**医保局专用终端机**刷卡结算，不需要诊所软件对接。接口对接需卫健委审批、各省标准不同，个人/小团队无法实现。 |
| **财税合规/电子发票** | ~~P0~~ | 诊所开发票使用**税控盘（航信/百旺）在税务系统直接操作**，不需要诊所管理软件对接。电子发票 API 对接需要税控服务商资质和商务合作，ROI 极低。实际需求仅为在收费记录上标记发票号，已可通过备注字段实现。 |
| **支付网关 API 集成** | ~~P0~~ | 诊所收款流程为：**前台告知金额 → 患者扫诊所收款码/刷卡/付现 → 前台录入支付方式**。不需要软件调用微信/支付宝 API（那是电商场景）。实际需求仅为 payment_method 枚举扩充。 |
| **患者端小程序** | ~~P0~~ | 微信小程序是**完全独立的前端项目**（WXML/WXSS/JS 技术栈），不属于 Laravel 管理系统范畴。API v1 已就绪可供对接，但小程序开发是另一个独立项目。 |
| **企微 SCRM** | ~~P1~~ | 企微 SCRM 是**大型连锁诊所才需要的能力**（年费 10万+），中小诊所用微信群 + 朋友圈 + 美团即可。简化为"患者召回提醒"功能。 |
| **多租户 SaaS + 订阅计费** | ~~P2~~ | **过度工程**。中小诊所用单租户私有部署即可。真正的 SaaS 化用 Docker 多实例部署比 tenant_id 行级改造简单得多，且不引入全局 Scope 的复杂性。 |
| **集团连锁能力** | ~~P2~~ | 连锁集团（5 店以上）已有成熟方案（领健/牙医管家），不会采购新系统。且需多租户前置，属于当前阶段不现实的目标。 |
| **前端现代化** | ~~P2~~ | jQuery + Bootstrap 管理后台**完全满足诊所使用场景**。重写前端零业务价值，且会引入构建工具链复杂性。 |
| **AI 辅助诊疗** | ~~P2~~ | AI 医疗影像分析需要**三类医疗器械注册证**（NMPA 审批 + 临床试验），动辄千万投入。语音录入有讯飞听见等成熟 SaaS 可直接使用。个人/小团队完全不现实。 |
| **专科扩展模块** | ~~P3~~ | 正畸/种植/儿牙专科管理**极其复杂**，需要深入的临床专业知识参与设计。已有专门产品（如悦见正畸管理），通用 PMS 不需要重复造轮子。 |

> **总结**：路线图从 33 项精简至 **18 项**，聚焦诊所内部管理软件可独立实现的功能。外部系统对接（医保/金税/支付API/小程序）、需要政府资质的功能（AI 医疗器械）、以及过度工程（多租户/集团连锁/前端重写）均已移除。

---

## 路线图实施进度总览

> **统计截止：2026-02-24** | 基于代码仓库 `master` 分支实际情况

| 阶段 | 子项 | 完成度 | 说明 |
|---|---|---|---|
| **阶段一** 基础设施加固 | 1.1 Laravel 升级 | **✅ 100%** | 已完成 5.8→6→8→9→10→11.x 全部升级 |
|  | 1.2 测试体系 | **✅ 100%** | 29 套件 220+ 测试，发现并修复 15+ 个 bug |
|  | 1.3 CI/CD | **✅ 100%** | GitHub Actions（PHPUnit + 前端构建，MySQL service container） |
|  | 1.4 Docker 化 | **✅ 100%** | docker-compose 5 服务 + Dockerfile + entrypoint + scheduler cron |
|  | 1.5 Windows 部署包 | **✅ 100%** | Laragon + Inno Setup 一键安装包 |
| **阶段二** 架构优化 | 2.1 API 层抽离 | **✅ 100%** | 19 资源 126 端点 + 限流 + 版本管理 + OpenAPI 文档 |
|  | 2.2 Service 层 | **✅ 95%** | 105+ Service 类，105+ Controller 重构 |
|  | 2.3 队列异步化 | **✅ 100%** | Redis 队列驱动 + Docker worker + 3 Job 重试配置 |
|  | 2.4 缓存策略 | **✅ 100%** | Redis 缓存驱动 + 7 个缓存点 |
|  | 2.5 模块迁移 | **✅ 100%** | Modules/ 5 模块全部迁入 app 层 |
|  | 2.6 动态菜单系统 | **✅ 100%** | MenuItem 模型 + MenuService + 权限驱动过滤 + CRUD 管理 |
|  | 2.7 布局统一 | **✅ 100%** | 5 模块布局文件删除，统一 layouts.app |
| **阶段三** 合规与安全 | 3.2 电子病历合规 | **🟡 60%** | 版本号 + 修改审批 + 电子签名 + PDF 归档。缺：15 年保存策略、打印水印 |
|  | 3.4 数据安全 | **🟡 70%** | NIN 加密 + 展示脱敏 + 导出脱敏 + 审计日志 + 密码策略 + 备份加密。缺：异地备份策略、等保文档 |
|  | 3.5 支付方式扩充 | **🟡 50%** | 储值余额已有。缺：ENUM 扩充（微信/支付宝/银行卡） |
|  | 3.6 器械消毒追溯 | **🔴 0%** | P1 口腔门诊监管重点 |
|  | 3.7 收费合规与价格管理 | **🔴 0%** | P1 价格锁定 + 变更审批 |
| **阶段四** 业务功能扩展 | 4.2 患者召回与短信 | **🔴 0%** | P1 沉睡患者识别 + 复查提醒 + 国内短信通道 |
|  | 4.3 知情同意书 | **🔴 0%** | P1 合规需要 |
|  | 4.4 电子表单/健康问卷 | **🔴 0%** | P1 减少纸质流程 |
|  | 4.5 技工单管理 | **✅ 100%** | API 层 + Web 层已全部完成 |
|  | 4.8 系统维护管理 | **✅ 100%** | 备份管理 + 保留策略 + 3 类日志查看器 |
|  | 4.9 角色管理增强 | **✅ 100%** | 4 Tab 页面：信息/权限/菜单/用户 |
| **阶段五** 运营增长 | 5.1 经营 BI 平台 | **🟡 65%** | 12 个报表控制器。缺：经营驾驶舱、高级分析 |

**整体进度：阶段一 ✅ 100%，阶段二 ✅ 100%，阶段三 🟡 ~40%（3.2 + 3.4 大部分完成），阶段四 🟡（4.5 + 4.8 + 4.9 已完成），阶段五 🟡 65%。**

---

## 阶段一：基础设施加固 — ✅ 全部完成

**目标**：消除技术债务，建立工程化基础，使系统具备可交付质量。

### 1.1 Laravel 版本升级路径 — ✅ 100% 完成

```
5.8 → 6.x → 7.x → 8.x → 9.x → 10.x → 11.x
              ↑ 跳过      ✅    ✅    ✅     ✅
```

**已完成的升级步骤：**

| 步骤 | 状态 | 提交记录 |
|---|---|---|
| 5.8 → 6.x | ✅ 已完成 | （合并在 6→8 中） |
| 6.x → 8.x | ✅ 已完成 | `188ee67` upgrade: Laravel 6.x → 8.x |
| Guzzle 升级到 7.x | ✅ 已完成 | `c89e9bb` chore: remove africastalking, upgrade Guzzle |
| 8.x → 9.x | ✅ 已完成 | `bb07ab1` upgrade: Laravel 8.x → 9.x with PHP 8.1 |
| 9.x → 10.x | ✅ 已完成 | `7062d90` upgrade: Laravel 9.x → 10.x |
| TrustProxies 适配 | ✅ 已完成 | `6cca1ea` fix: add HEADER_X_FORWARDED_PREFIX |
| 10.x → 11.x | ✅ 已完成 | 代码适配 + composer 升级 |

**依赖包兼容矩阵：**

| 包 | 原始版本 | 当前版本 | 状态 |
|---|---|---|---|
| `maatwebsite/excel` | 2.1 | 3.1 | ✅ |
| `yajra/datatables` | 9.7 | 10.0 | ✅ |
| `owen-it/laravel-auditing` | 10.0 | 13.0 | ✅ |
| `barryvdh/laravel-dompdf` | — | 2.0 | ✅ |
| `spatie/laravel-backup` | — | 8.0 | ✅ |
| `knuckleswtf/scribe` | — | 5.7 | ✅ |
| `maddhatter/laravel-fullcalendar` | 1.3 | 仍在使用 | ⬜ 待替换 |
| `jimmyjs/report-generator` | 1.1 | 仍在使用 | ⬜ 待替换 |

### 1.2 测试体系建设 — ✅ 100% 完成

**当前状态**：29 个测试套件，220+ 测试，PHPUnit 10.0，MySQL 测试数据库。

```
Phase A: 冒烟测试                                    ✅（40 测试 / 134 断言）
├── AuthSmokeTest (14)
├── PatientCrudSmokeTest (9)
├── AppointmentCrudSmokeTest (8)
└── InvoiceCrudSmokeTest (9)

Phase B: 核心业务测试                                 ✅（49 测试 / ~170 断言）
├── NameHelperTest (8)
├── FinancialCalculationTest (8)
├── DiscountWorkflowTest (7)
├── MixedPaymentTest (6)
├── RefundWorkflowTest (9)
├── PermissionCacheTest (5)
└── MemberServiceTest (6)

Phase C: 回归测试                                     ✅（6 测试 / ~15 断言）
└── RegressionTest（DataTables/PDF/Excel/Job）

Phase D: API 端点测试                                  ✅（108 测试 / 342 断言）
├── InventoryItemApiTest (9)    ├── PrescriptionApiTest (8)
├── MemberApiTest (14)          ├── DentalChartApiTest (5)
├── DoctorClaimApiTest (7)      ├── InvoicePaymentApiTest (8)
├── TreatmentApiTest (7)        ├── RefundApiTest (8)
├── TreatmentPlanApiTest (7)    ├── QuotationApiTest (5)
├── MasterDataApiTest (12)      └── LabCaseApiTest (18)

Phase E: Web 补充测试                                  ✅
├── ProceduresReportSmokeTest (2)
├── QuotationSmokeTest
└── UserListAjaxTest
```

### 1.3 CI/CD 管线 — ✅ 100% 完成

- ✅ `.github/workflows/ci.yml` — test job (PHP 8.2 + MySQL 8.0) + build job (Node.js 16)
- ✅ 触发条件：push 到 `master` / `upgrade/laravel-10`，PR 到 `master`

### 1.4 Docker 化 — ✅ 100% 完成

```
docker-compose.yml
├── app        (PHP-FPM + Laravel + cron scheduler)
├── worker     (队列消费者, restart: unless-stopped)
├── nginx      (Web 服务器, port 80)
├── mysql      (MySQL 8.0, healthcheck, 持久化 volume)
└── redis      (Redis 7-alpine, 持久化 volume)
```

### 1.5 Windows 部署包 — ✅ 100% 完成

Laragon + Inno Setup 一键安装包（post-install + startup 脚本）。

---

## 阶段二：架构优化 — ✅ 全部完成

### 2.1 API 层抽离 — ✅ 100% 完成

19 个资源 126 端点，21 个控制器 + 20 个 Resource，108 个 API 端点测试全部通过。

```
routes/api/v1.php — 126 端点
├── /api/v1/auth               (3 端点)
├── /api/v1/patients           (8 端点)
├── /api/v1/appointments       (9 端点)
├── /api/v1/invoices           (9 端点)
├── /api/v1/medical-cases      (7 端点)
├── /api/v1/inventory-items    (8 端点)
├── /api/v1/members            (6 端点)
├── /api/v1/member-levels      (5 端点)
├── /api/v1/doctor-claims      (6 端点)
├── /api/v1/treatments         (5 端点)
├── /api/v1/treatment-plans    (6 端点)
├── /api/v1/prescriptions      (7 端点)
├── /api/v1/dental-charts      (4 端点)
├── /api/v1/invoice-payments   (7 端点)
├── /api/v1/refunds            (7 端点)
├── /api/v1/quotations         (4 端点)
├── /api/v1/medical-services   (5 端点)
├── /api/v1/suppliers          (5 端点)
├── /api/v1/labs               (5 端点)
└── /api/v1/lab-cases          (10 端点)
```

API 运维：限流（分级策略）+ OpenAPI 文档（Scribe + Scalar UI）+ 版本管理中间件。

**待完成：**
- ⬜ `invoice_payments.payment_method` ENUM 扩充（添加微信/支付宝/银行卡/储值）

### 2.2 Service 层引入 — ✅ 95% 完成

105+ Service 类，105+ Controller 重构为调用 Service 层。

### 2.3 队列异步化 — ✅ 100% 完成

Redis 队列 + Docker worker + 3 Job（SMS/邮件发票/邮件报价）重试配置。

### 2.4 缓存策略 — ✅ 100% 完成

| 缓存 Key | TTL | 失效触发 |
|-----------|-----|----------|
| `role:{id}:permissions` | 1h | RolePermissionService 增/改/删 |
| `medical_services:names` | 6h | MedicalServiceService 增/改/删 |
| `branches:all` | 6h | BranchService 增/改/删 |
| `insurance_companies:all` | 24h | InsuranceCompanyService 增/改/删 |
| `patient_sources:active` | 6h | PatientSourceService 增/改/删 |
| `member_levels:all` | 24h | MemberService 增/改/删 |

### 2.5 模块迁移 — ✅ 100% 完成

7 个控制器 + 10 个视图 + 路由全部迁入 app 层，Modules/ 目录已删除。

**遗留项：**
- [ ] 从 `composer.json` 移除 `nwidart/laravel-modules` 包

### 2.6 动态菜单系统 — ✅ 100% 完成

MenuItem 模型 + MenuService + 权限过滤 + CRUD 管理 + MenuItemsSeeder + 侧边栏动态渲染。

### 2.7 布局统一 — ✅ 100% 完成

5 个模块 `layouts/master.blade.php` 删除，统一为 `FunctionsHelper::navigation()` → `'layouts.app'`。

---

## 阶段三：合规与安全

> **前置依赖**：阶段二已全部完成 ✅。

### 3.2 电子病历合规增强 — 🟡 60% 完成

符合《电子病历基本规范》和《医疗质量管理办法》要求。

```
电子病历合规
├── 医生签名锁定机制                    ← ✅ signed_at + locked_at 字段
├── 病历修改版本号                      ← ✅ version_number 自动递增
├── 病历修改留痕（diff 记录）            ← ✅ MedicalCaseAmendment 模型
├── 修改审批流程                        ← ✅ pending/approved/rejected
├── 操作审计（不可删除）                ← ✅ owen-it/laravel-auditing 集成
├── 导出标准 PDF                        ← ✅ PDF 归档已实现
├── 医生签名图像                        ← ✅ signature 字段已有
├── 最低保存 15 年                      ← 🔴 需保留策略配置
└── 病历打印水印                        ← 🔴 需添加时间戳+操作人
```

**待完成：**
- [ ] 15 年保存策略配置（数据归档 + 备份保留策略）
- [ ] 病历打印水印（含时间戳、操作人）
- [ ] CA 数字证书签名（依赖第三方服务，低优先级）

### 3.4 数据安全 — 🟡 70% 完成

```
数据安全体系
├── NIN 加密存储 + blind index           ← ✅ EncryptsNin Trait
├── 展示层脱敏 + 揭示开关 + 揭示审计    ← ✅ DataMaskingService + revealPii 端点
├── 导出脱敏（可配置开关）              ← ✅ PatientExport + SmsLoggingExport
├── 导出 + 敏感访问审计                 ← ✅ 9 个 Controller 审计
├── 备份文件加密                        ← ✅ backup.php password
├── 密码强度策略                        ← ✅ StrongPassword Rule
├── 会话超时                            ← ✅ session.php lifetime=60
├── RBAC 精细化                         ← ✅ export-patients + view-sensitive-data 权限
├── 审计日志不可删除                    ← ✅ 4 类审计表 + laravel-auditing
├── 异地备份                            ← 🟡 spatie/laravel-backup 已集成，需配置异地策略
└── 私有化部署支持                      ← ✅ Docker 已就绪
```

**待完成：**
- [ ] 异地备份策略配置（S3/OSS 远程存储）
- [ ] 等保测评准备文档（技术措施清单）
- [ ] HTTPS 强制中间件

### 3.5 支付方式扩充 — 🟡 50% 完成

> **说明**：中国口腔诊所收款流程为线下操作（患者扫码/刷卡/付现），诊所管理软件只需**记录支付方式**，不需要调用支付 API。

**已有：**
- ✅ 混合支付逻辑（现金 + 储值余额 + 其他方式同时使用）
- ✅ 储值余额抵扣
- ✅ 支付记录 CRUD + API

**待完成：**
- [ ] `invoice_payments.payment_method` ENUM 扩充：添加 `WeChat`（微信）、`Alipay`（支付宝）、`BankCard`（银行卡/POS）、`StoredValue`（储值余额）
- [ ] 支付方式统计报表增强（按微信/支付宝/现金/银行卡分维度统计）

### 3.6 器械消毒追溯 — 🔴 未开始（P1）

口腔门诊卫生监管检查重点，涉及交叉感染防控。**不做这个功能，卫生局检查可能不过关。**

```
器械消毒管理
├── 器械包登记（名称、包内器械清单、创建日期）
├── 灭菌批次号（每次灭菌生成唯一批次号）
├── 灭菌记录（温度、时长、操作人、灭菌方式）
├── 关联患者（使用记录：哪个器械包在哪次诊疗中使用）
├── 过期提醒（灭菌有效期到期提醒）
└── 监管报表（按日期/器械类型导出灭菌记录）
```

**数据模型：**

```sql
sterilization_kits      -- 器械包
├── id, kit_no, name
├── instruments          -- 包内器械清单 (JSON)
└── is_active

sterilization_records   -- 灭菌记录
├── id, kit_id, batch_no
├── method (高压蒸汽/化学/干热)
├── temperature, duration_minutes
├── operator_id, sterilized_at
├── expires_at           -- 有效期
├── biological_indicator -- 生物指示剂结果
└── status (待灭菌/已灭菌/已使用/已过期)

sterilization_usages    -- 使用记录（关联患者诊疗）
├── sterilization_record_id
├── patient_id, medical_case_id, appointment_id
└── used_at, used_by
```

### 3.7 收费合规与价格管理 — 🔴 未开始（P1）

监管要求收费透明，患者投诉"乱收费"的法律风险。

```
收费合规
├── 医疗服务价格锁定（管理员设定，前台不可随意修改）
├── 价格变更审批流（谁改的、改了什么、谁批准的）
├── 价格变更历史记录（审计追踪）
├── 折扣审批增强（已有基础 ✅，扩展上限/分级审批）
└── 收费公示清单导出（PDF，用于前台公示）
```

**数据模型增强：**

```sql
-- medical_services 表增加字段
price_locked_at          -- 价格锁定时间
price_locked_by          -- 锁定操作人
price_change_requires_approval  BOOLEAN DEFAULT TRUE

-- 新增：价格变更记录表
service_price_changes
├── medical_service_id
├── old_price, new_price
├── reason               -- 变更原因
├── requested_by, approved_by
├── status (pending/approved/rejected)
└── effective_date       -- 生效日期
```

---

## 阶段四：业务功能扩展

> **前置依赖**：阶段二 API 层和 Service 层已完成 ✅。

### 4.2 患者召回与短信通道 — 🔴 未开始（P1）

诊所运营核心：把沉睡患者叫回来。

```
Phase A: 患者召回提醒（优先）
├── 沉睡患者自动识别：N 天未就诊自动标记（可配置天数）
├── 复查/洁牙定期提醒：根据上次就诊日期 + 推荐间隔自动生成
├── 治疗中断提醒：治疗方案未完成的患者
├── 生日祝福（已有基础）
├── 国内短信通道适配：阿里云 SMS / 腾讯云 SMS
└── 提醒日志：发送记录、触达状态、响应跟踪

Phase B: 扩展（后期）
├── 微信服务号模板消息（比小程序简单，仅需公众号）
└── 提醒效果统计：发送→阅读→预约转化率
```

**数据模型：**

```sql
patient_recall_rules    -- 召回规则
├── name, type (沉睡召回/复查提醒/治疗中断/生日)
├── days_threshold       -- 触发天数
├── message_template     -- 短信模板
├── is_active
└── applies_to           -- 适用条件 (JSON)

patient_recalls         -- 召回记录
├── patient_id, rule_id
├── scheduled_date       -- 计划发送日期
├── sent_at, channel (sms/wechat)
├── status (pending/sent/failed/responded)
└── response_appointment_id  -- 响应后创建的预约（跟踪转化）
```

**短信通道：**

```php
// 抽象接口（替代已移除的 AfricasTalking）
interface SmsChannel {
    public function send(string $phone, string $message): SmsResult;
    public function getBalance(): float;
}

// 实现
App\Services\Sms\
├── AliyunSmsChannel.php    -- 阿里云 SMS
├── TencentSmsChannel.php   -- 腾讯云 SMS
└── LogSmsChannel.php       -- 开发环境（仅记录日志）
```

### 4.3 知情同意书管理 — 🔴 未开始（P1）

诊所合规必需，避免医疗纠纷。

```sql
consent_templates       -- 同意书模板
├── template_name, template_type (手术/麻醉/影像/通用)
├── content              -- 富文本内容
├── required_for_services -- 关联的医疗服务项目 (JSON)
└── version, is_active

patient_consents        -- 患者签署记录
├── patient_id, template_id, medical_case_id
├── signed_at, signature_image
├── witness_name, doctor_id
└── pdf_path             -- 存档 PDF
```

### 4.4 电子表单/健康问卷 — 🔴 未开始（P1）

初诊信息采集数字化，减少纸质表单，提高效率。

```sql
form_templates          -- 表单模板
├── name, type (初诊表/健康问卷/儿童问卷/术前评估)
├── fields              -- JSON Schema 定义表单字段
└── is_active, version

form_submissions        -- 患者提交
├── patient_id, template_id
├── data                -- JSON 提交数据
├── submitted_at, submitted_via (现场iPad/电脑录入)
└── reviewed_by, reviewed_at
```

### 4.5 技工单/义齿加工管理 — ✅ 100% 完成

```
已完成：
├── 数据层：labs + lab_cases 表、Lab/LabCase Model、LabService/LabCaseService
├── API 层：2 个 API Controller（15 端点）、18 个测试全部通过
├── Web 层：2 个 Web Controller、7 个 Blade 视图、PDF 打印模板
└── i18n：zh-CN + en 语言文件
```

### 4.8 系统维护管理 — ✅ 100% 完成

备份管理 + 保留策略 + 3 类日志查看器（操作/访问/审计）。

### 4.9 角色管理增强 — ✅ 100% 完成

4 Tab 页面：基本信息 / 权限矩阵 / 菜单可见性 / 关联用户。

---

## 阶段五：运营增长

### 5.1 经营 BI 平台 — 🟡 65% 完成

**已实现的 12 个报表：**

| # | 报表 | 控制器 | 状态 |
|---|---|---|---|
| 1 | 日收入报表 | `InvoicingReportsController` | ✅ |
| 2 | 医生绩效报表 | `DoctorPerformanceReport` | ✅ |
| 3 | 项目收入报表 | `ProceduresReportController` | ✅ |
| 4 | 欠费报表 | `DebtorsReportController` | ✅ |
| 5 | 就诊率报表 | `RevisitRateReportController` | ✅ |
| 6 | 患者来源报表 | `PatientSourceReportController` | ✅ |
| 7 | 预约分析报表 | `AppointmentAnalyticsReportController` | ✅ |
| 8 | 治疗方案完成率 | `TreatmentPlanCompletionReportController` | ✅ |
| 9 | 月度经营总览 | `MonthlyBusinessSummaryReportController` | ✅ |
| 10 | 患者画像报表 | `PatientDemographicsReportController` | ✅ |
| 11 | 医生工作量报表 | `DoctorWorkloadReportController` | ✅ |
| 12 | 报价转化率 | `QuotationConversionReportController` | ✅ |

**待完成：**

| 能力 | 现有 | 需补齐 |
|---|---|---|
| 经营驾驶舱 | 无 | 管理者首页 Dashboard，关键指标一屏总览 |
| 同比环比分析 | 无 | 月度/年度对比趋势 |
| 患者复诊转化 | 🟡 就诊率报表 | 从初诊到复诊的转化率分析 |

---

## 实施优先级与依赖关系

```
阶段一 基础设施加固                            ✅ 100%
├─ 1.1 Laravel升级
├─ 1.2 测试体系
├─ 1.3 CI/CD
├─ 1.4 Docker化
└─ 1.5 Windows部署包
          │
          ▼
阶段二 架构优化                                ✅ 100%
├─ 2.1 API层抽离
├─ 2.2 Service层
├─ 2.3 队列异步化
├─ 2.4 缓存策略
├─ 2.5 模块迁移
├─ 2.6 动态菜单系统
└─ 2.7 布局统一
          │
          ▼
┌─────────┴──────────┐
▼                    ▼
阶段三 合规安全    阶段四 业务扩展
│（可并行）        │（可并行）
├─ 3.2 病历合规 🟡 ├─ 4.2 患者召回+短信  (P1)
├─ 3.4 数据安全 🟡 ├─ 4.3 知情同意书     (P1)
├─ 3.5 支付方式    ├─ 4.4 电子表单       (P1)
├─ 3.6 消毒追溯    ├─ 4.5 技工单管理 ←── ✅ 100%
└─ 3.7 收费合规    ├─ 4.8 系统维护 ←───── ✅ 100%
                   └─ 4.9 角色管理 ←───── ✅ 100%
          │                │
          └────────┬───────┘
                   ▼
             阶段五 运营增长
             └─ 5.1 经营BI平台              🟡 65%
```

**关键路径**：3.2/3.4 收尾 → 3.6 器械消毒 + 3.7 收费合规 → 4.2 患者召回 → 5.1 经营驾驶舱。

---

## 商业化定价建议

| 版本 | 目标客户 | 核心功能 | 限制 |
|---|---|---|---|
| 免费版 | 个体诊所试用 | 患者 + 预约 + 基础账单 | 1 用户、200 患者 |
| 标准版 | 单店诊所 | 全功能 + 库存 + 报表 + 技工单 + 消毒追溯 | 5 用户、1 门店 |
| 专业版 | 2-3 店连锁 | 标准版 + 会员 + 绩效 + API + 患者召回 | 15 用户、3 门店 |

> **建议首先推出标准版**，当前功能已覆盖单店诊所核心需求。用真实客户反馈驱动后续迭代。
>
> **不建议做企业版/集团版** — 那个市场已被领健/牙医管家占领，且需要完全不同的产品形态和销售团队。

---

## 下一步优先行动建议

> **更新于 2026-02-24**

### 已完成里程碑（1-18）

1. ~~Laravel 5.8→11.x 升级（1.1）~~ ✅
2. ~~Service 层引入（2.2）~~ ✅ 105+ Service
3. ~~API v1 层（2.1）~~ ✅ 19 资源 126 端点 + 限流 + 文档
4. ~~测试体系（1.2）~~ ✅ 29 套件 220+ 测试
5. ~~CI/CD（1.3）~~ ✅ GitHub Actions
6. ~~队列异步化（2.3）~~ ✅ Redis + Docker worker
7. ~~Docker 化（1.4）~~ ✅ 5 服务编排
8. ~~缓存策略（2.4）~~ ✅ Redis + 7 缓存点
9. ~~技工单管理（4.5）~~ ✅ API + Web 全部完成
10. ~~电子病历合规基础（3.2）~~ 🟡 60% — 版本号 + 修改审批 + 电子签名 + PDF 归档
11. ~~经营报表扩展（5.1）~~ 🟡 65% — 12 个报表控制器
12. ~~模块迁移（2.5）~~ ✅ Modules/ 5 模块全部迁入 app 层
13. ~~动态菜单系统（2.6）~~ ✅ MenuItem + MenuService + 权限过滤
14. ~~布局统一（2.7）~~ ✅ 5 模块布局合并为 layouts.app
15. ~~系统维护管理（4.8）~~ ✅ 备份 + 日志查看器
16. ~~角色管理增强（4.9）~~ ✅ 4 Tab 页面
17. ~~Windows 部署包（1.5）~~ ✅ Laragon + Inno Setup 安装包
18. ~~数据安全与等保（3.4）~~ 🟡 70% — NIN 加密 + 脱敏 + 审计 + 密码策略

### 当前推荐任务（按优先级）

**收尾项（快速关闭 → 提高完成度）：**

19. **移除 nwidart/laravel-modules 包** — 从 composer.json 移除 + `config/modules.php`
20. **3.2 电子病历合规收尾** — 15 年保存策略 + 病历打印水印
21. **3.4 数据安全收尾** — 异地备份策略配置 + HTTPS 中间件
22. **3.5 支付方式 ENUM 扩充** — payment_method 添加微信/支付宝/银行卡/储值

**核心新功能（P1 — 高业务价值）：**

23. **收费合规与价格管理**（3.7）— 价格锁定 + 变更审批 + 公示清单。不依赖外部接口，纯内部逻辑，开发量适中。
24. **器械消毒追溯**（3.6）— 器械包登记 + 灭菌批次 + 关联患者 + 过期提醒。卫生监管检查刚需。
25. **知情同意书管理**（4.3）— 模板管理 + 患者签署 + PDF 归档。医疗纠纷防范。
26. **患者召回与短信通道**（4.2）— 沉睡患者识别 + 复查提醒 + 阿里云/腾讯云 SMS 适配。运营核心。

**经营分析升级：**

27. **经营驾驶舱**（5.1）— 管理者首页 Dashboard（日营收/预约量/新患数/待审批/欠费汇总一屏总览）
28. **电子表单/健康问卷**（4.4）— 初诊表数字化，减少纸质流程

---

## 参考资料

- [牙医管家官网](https://www.dentalink.com.cn/) — 国内口腔诊所 SaaS 参考
- [领健·e看牙官网](https://www.linkedcare.cn/kouqiang) — PMS + EMR 一体化方案参考
