# 动态菜单实现方案

## 一、现状分析

| 维度             | 现状                                                         |
| ---------------- | ------------------------------------------------------------ |
| **侧边栏选择**   | 按角色名硬匹配（`FunctionsHelper::navigation()`），5 个角色 = 5 个独立 blade |
| **菜单项总数**   | 248 个，分散在 5 个文件                                      |
| **使用 `@can()` 的** | 仅 2 个（`manage-system-maintenance`），占 0.8%          |
| **权限数据库**   | 47 个权限已定义 + 缓存，但几乎只用在路由层，不用在 UI 层     |
| **Menu 表**      | 不存在，菜单完全硬编码                                       |

**核心问题**：用户能看到无权访问的菜单项 → 点击后才返回 403。

---

## 二、目标与收益

| 收益             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| **单一数据源**   | 248 个菜单项从 5 个 blade 文件合并为 1 张 `menu_items` 表（~93 条记录） |
| **权限联动**     | 每个菜单项通过外键关联 `permissions` 表，自动根据用户权限过滤 |
| **新角色零代码** | 新增角色只需在 `role_menu_items` 表配置菜单可见性            |
| **统一渲染**     | 5 个 layout 文件统一引用 `sidebar-dynamic.blade.php`         |
| **全外键关联**   | 三张表通过 FK 关联，无硬编码字符串                           |

---

## 三、数据模型

### 3.1 表结构

```sql
-- 菜单项表（无外键约束，通过程序控制关联完整性）
CREATE TABLE menu_items (
    id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    parent_id       BIGINT UNSIGNED NULL,          -- 上级节点（3 级树结构）
    title_key       VARCHAR(100) NOT NULL,          -- i18n 键，如 'menu.patients_list'
    url             VARCHAR(255) NULL,              -- NULL = 目录节点，有值 = 叶子链接
    icon            VARCHAR(50)  NULL,              -- CSS 图标类，如 'icon-users'
    permission_id   BIGINT UNSIGNED NULL,           -- 关联 permissions.id，NULL = 不检查
    sort_order      INT DEFAULT 0,
    is_active       TINYINT(1) DEFAULT 1,
    created_at      TIMESTAMP NULL,
    updated_at      TIMESTAMP NULL,
    INDEX idx_parent_sort (parent_id, sort_order),
    INDEX idx_active (is_active)
);

-- 角色-菜单关联表（无外键约束，通过程序控制关联完整性）
CREATE TABLE role_menu_items (
    id              BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    role_id         BIGINT UNSIGNED NOT NULL,       -- 关联 roles.id
    menu_item_id    BIGINT UNSIGNED NOT NULL,       -- 关联 menu_items.id
    UNIQUE KEY uk_role_menu (role_id, menu_item_id),
    INDEX idx_role (role_id),
    INDEX idx_menu_item (menu_item_id)
);
```

### 3.2 三表关联关系

```
roles ←──── role_menu_items ────→ menu_items ────→ permissions
  │                                                     ↑
  └──── role_permissions ───────────────────────────────┘
```

| 关联                           | 作用                                   |
| ------------------------------ | -------------------------------------- |
| `role_menu_items`              | 角色能**看到**哪些菜单节点（结构可见性） |
| `role_permissions`（已有）     | 角色拥有哪些**权限**                   |
| `menu_items.permission_id`     | 菜单项需要哪个权限才显示（二次过滤）   |

**两层控制逻辑**：

```
用户请求 → 查 role_menu_items（结构可见性）→ 查 permission_id（权限过滤）→ 渲染
```

| 层                     | 作用                           | 数据来源                            |
| ---------------------- | ------------------------------ | ----------------------------------- |
| **第一层：结构可见性** | 决定该角色能看到哪些菜单节点   | `role_menu_items` 关联 `roles` 表   |
| **第二层：权限过滤**   | 菜单项绑定权限，检查用户是否有 | `permissions` + `role_permissions`   |

---

## 四、角色差异处理

当前 5 个 sidebar 的结构差异分析（动态菜单的核心难点）：

| 差异类型       | 示例                                                         | 处理方式                                           |
| -------------- | ------------------------------------------------------------ | -------------------------------------------------- |
| **组 vs 直链（可合并）** | SA "患者档案" 是组（含 3 子项），DNR 是直链 `/patients` | **同一条记录**，设 `url=patients`，子项只分配 SA 角色。SA 有子项→渲染为目录，DNR 无子项→自动渲染为直链 |
| **组 vs 直链（不可合并）** | S 看保险理赔组，D 直链 `/doctor-claims` | URL 不同，必须保留为两条独立记录 |
| **不同 URL**   | Admin 看 `/payslips`（全员工资单），Doctor 看 `/individual-payslips`（个人） | 两条独立记录，不同 URL，分配不同角色                |
| **不同子项**   | Admin 候诊管理有 4 项，Doctor 只有 2 项（含 `doctor-queue`） | 子项各自在 `role_menu_items` 中分配角色             |
| **整节缺失**   | Doctor/Nurse 无 "数据中心"、"系统设置"                       | 顶级节点的 `role_menu_items` 不含这些角色           |

### 合并策略

关键设计：当一个菜单节点同时设有 `url` 和子项时，`_menu_node.blade.php` 的渲染逻辑会自动适配：

- **有可见子项** → `$item->children->isNotEmpty()` 为 true → 渲染为可展开目录（忽略 url）
- **无可见子项** → 渲染为直链（使用 url）

`buildRoleTree()` 按角色查询 `role_menu_items`，未分配的子项不会加载，因此同一父节点对不同角色呈现不同形态。

**已合并的 5 组**：

| 节点 | url | 目录角色 | 直链角色 |
| ---- | --- | -------- | -------- |
| 患者档案 | `patients` | SA（3 子项） | DNR |
| 会员管理 | `members` | SAR（3 子项） | DN |
| 病历管理 | `medical-cases` | SAD（3 子项） | N |
| 账务管理 | `self-accounts` | SA（3 子项） | R |
| 绩效管理 | `doctor-performance-report` | SA（2 子项） | D |
| 保险理赔 | `insurance-companies` | S（3 子项） | A |

**保留独立的 2 组**（无法合并）：

| 节点 | 原因 |
| ---- | ---- |
| 保险理赔（D） | D 的直链 URL 为 `doctor-claims`，与 SA 的 `insurance-companies` 不同 |
| 请假申请 | SA 在"考勤假期"子组内，DNR 在"运营中心"直挂，父节点不同 |

**种子数据量**：

| 表               | 行数   | 说明                                                     |
| ---------------- | ------ | -------------------------------------------------------- |
| `menu_items`     | 93 条  | 所有菜单节点（合并后）                                   |
| `role_menu_items` | 249 条 | 角色-菜单关联                                            |

---

## 五、核心服务

### 5.1 Model 关系

```php
// app/Models/MenuItem.php
class MenuItem extends Model
{
    protected $fillable = [
        'parent_id', 'title_key', 'url', 'icon',
        'permission_id', 'sort_order', 'is_active',
    ];

    public function parent(): BelongsTo
    {
        return $this->belongsTo(MenuItem::class, 'parent_id');
    }

    public function children(): HasMany
    {
        return $this->hasMany(MenuItem::class, 'parent_id')->orderBy('sort_order');
    }

    public function permission(): BelongsTo
    {
        return $this->belongsTo(Permission::class);
    }

    public function roles(): BelongsToMany
    {
        return $this->belongsToMany(Role::class, 'role_menu_items');
    }
}

// app/Role.php（追加关系）
public function menuItems(): BelongsToMany
{
    return $this->belongsToMany(MenuItem::class, 'role_menu_items');
}
```

### 5.2 MenuService

```php
// app/Services/MenuService.php
class MenuService
{
    public function getMenuTreeForUser(User $user): Collection
    {
        $role = $user->UserRole;

        // 按角色缓存菜单树（与权限缓存同 TTL）
        $tree = Cache::remember("menu_tree:role:{$role->id}", 3600, function () use ($role) {
            return $this->buildRoleTree($role->id);
        });

        // 运行时过滤权限（权限已缓存，几乎零开销）
        return $this->filterByPermission($tree, $user);
    }

    private function buildRoleTree(int $roleId): Collection
    {
        $items = MenuItem::where('is_active', true)
            ->whereHas('roles', fn ($q) => $q->where('roles.id', $roleId))
            ->with('permission')
            ->orderBy('sort_order')
            ->get();

        return $this->nestItems($items);
    }

    private function nestItems(Collection $items): Collection
    {
        $grouped = $items->groupBy('parent_id');
        $roots = $grouped->get(null, collect());

        $roots->each(function ($item) use ($grouped) {
            $this->assignChildren($item, $grouped);
        });

        return $roots;
    }

    private function assignChildren($item, Collection $grouped): void
    {
        $children = $grouped->get($item->id, collect());
        $item->setRelation('children', $children);
        $children->each(fn ($child) => $this->assignChildren($child, $grouped));
    }

    private function filterByPermission(Collection $tree, User $user): Collection
    {
        return $tree->filter(function ($item) use ($user) {
            // 有权限要求 → 检查
            if ($item->permission_id && !$user->hasPermission($item->permission->slug)) {
                return false;
            }
            // 递归过滤子节点
            if ($item->children->isNotEmpty()) {
                $item->setRelation('children',
                    $this->filterByPermission($item->children, $user)
                );
                // 目录节点无可见子项 → 隐藏
                if (!$item->url && $item->children->isEmpty()) {
                    return false;
                }
            }
            return true;
        })->values();
    }
}
```

### 5.3 缓存策略

- `menu_tree:role:{id}` — 按角色缓存树结构，TTL 3600s
- 权限过滤在运行时执行（权限本身已缓存于 `role:{id}:permissions`）
- 当角色权限变更时，需清除对应缓存（可在 `RolePermission` model event 中处理）

---

## 六、视图层

### 6.1 新建 `resources/views/partials/sidebar-dynamic.blade.php`

```blade
{{-- Dynamic Sidebar Menu --}}
<div class="page-sidebar-wrapper">
    <div class="page-sidebar navbar-collapse collapse">
        <ul class="page-sidebar-menu page-header-fixed"
            data-keep-expanded="false" data-auto-scroll="true" data-slide-speed="200">
            <li class="sidebar-toggler-wrapper hide">
                <div class="sidebar-toggler"><span></span></div>
            </li>
            <li class="sidebar-search-wrapper" style="padding: 15px 18px;">
                <span style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 600;">
                    {{ Auth::User()->branch->name ?? config('app.name') }}
                </span>
            </li>
            @foreach($menuTree as $item)
                @include('partials._menu_node', ['item' => $item, 'level' => 1])
            @endforeach
        </ul>
    </div>
</div>
```

### 6.2 新建 `resources/views/partials/_menu_node.blade.php`

```blade
@if($item->children->isNotEmpty())
    {{-- 有子节点 → 展开式菜单 --}}
    <li class="nav-item">
        <a href="javascript:;" class="nav-link nav-toggle">
            @if($item->icon)<i class="{{ $item->icon }}"></i>@endif
            <span class="title">{{ __($item->title_key) }}</span>
            <span class="arrow"></span>
        </a>
        <ul class="sub-menu">
            @foreach($item->children as $child)
                @include('partials._menu_node', ['item' => $child, 'level' => $level + 1])
            @endforeach
        </ul>
    </li>
@else
    {{-- 叶子节点 → 直链 --}}
    <li class="nav-item {{ $level === 1 ? 'start' : '' }}">
        <a href="{{ url($item->url) }}" class="nav-link">
            @if($item->icon)<i class="{{ $item->icon }}"></i>@endif
            <span class="title">{{ __($item->title_key) }}</span>
        </a>
    </li>
@endif
```

### 6.3 数据注入

在 `AppServiceProvider::boot()` 中用 View Composer 注入菜单数据：

```php
View::composer('partials.sidebar-dynamic', function ($view) {
    if (Auth::check()) {
        $view->with('menuTree', app(MenuService::class)->getMenuTreeForUser(Auth::user()));
    }
});
```

### 6.4 修改 5 个 layout 文件（每个改 1 行）

| 文件                                                         | 改动                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `resources/views/layouts/app.blade.php:36`                   | `@include('partials.sidebar-admin')` → `@include('partials.sidebar-dynamic')` |
| `Modules/SuperAdmin/Resources/views/layouts/master.blade.php:36` | `@include('partials.sidebar-superadmin')` → `@include('partials.sidebar-dynamic')` |
| `Modules/Doctor/Resources/views/layouts/master.blade.php:81` | `@include('partials.sidebar-doctor')` → `@include('partials.sidebar-dynamic')` |
| `Modules/Nurse/Resources/views/layouts/master.blade.php:81`  | `@include('partials.sidebar-nurse')` → `@include('partials.sidebar-dynamic')` |
| `Modules/Receptionist/Resources/views/layouts/master.blade.php:81` | `@include('partials.sidebar-receptionist')` → `@include('partials.sidebar-dynamic')` |

---

## 七、权限映射表

菜单项与 `permissions` 表的关联关系（93 条中有映射的约 50 条，通过 `permission_id` 外键）：

| URL                                   | permission (slug)           | 说明                   |
| ------------------------------------- | --------------------------- | ---------------------- |
| `patients`                            | `view-patients`             |                        |
| `patient-tags`                        | `manage-patient-settings`   |                        |
| `patient-sources`                     | `manage-patient-settings`   |                        |
| `members`                             | `manage-members`            |                        |
| `member-levels`                       | `manage-members`            |                        |
| `coupons`                             | `manage-members`            |                        |
| `patient-followups`                   | `view-patients`             |                        |
| `birthday-wishes`                     | `view-patients`             |                        |
| `satisfaction-surveys`                | `view-patients`             |                        |
| `patient-images`                      | `view-patients`             |                        |
| `appointments`                        | `view-appointments`         |                        |
| `doctor-schedules`                    | `manage-schedules`          |                        |
| `online-bookings`                     | `view-appointments`         |                        |
| `waiting-queue`                       | `view-appointments`         |                        |
| `doctor-queue`                        | `view-appointments`         |                        |
| `medical-cases`                       | `manage-medical-cases`      |                        |
| `dental-charting`                     | `manage-medical-cases`      |                        |
| `prescriptions`                       | `manage-treatments`         |                        |
| `treatment-plans`                     | `manage-treatments`         |                        |
| `clinic-services`                     | `manage-medical-services`   |                        |
| `medical-templates`                   | `manage-medical-services`   |                        |
| `quick-phrases`                       | `manage-medical-services`   |                        |
| `invoices`                            | `view-invoices`             |                        |
| `quotations`                          | `manage-quotations`         |                        |
| `refunds`                             | `manage-refunds`            |                        |
| `invoices/pending-discount-approvals` | `view-invoices`             |                        |
| `insurance-companies`                 | `manage-insurance`          |                        |
| `claim-rates`                         | `manage-insurance`          |                        |
| `doctor-claims`                       | `manage-doctor-claims`      |                        |
| `self-accounts`                       | `manage-accounting`         |                        |
| `charts-of-accounts`                  | `manage-accounting`         |                        |
| `sms-transactions`                    | `manage-sms`                |                        |
| `stock-ins`                           | `manage-inventory`          |                        |
| `stock-outs`                          | `manage-inventory`          |                        |
| `service-consumables`                 | `manage-inventory`          |                        |
| `inventory-categories`                | `manage-inventory`          |                        |
| `inventory-items`                     | `manage-inventory`          |                        |
| `suppliers`                           | `manage-inventory`          |                        |
| `lab-cases`                           | `manage-labs`               |                        |
| `labs`                                | `manage-labs`               |                        |
| `employee-contracts`                  | `manage-employees`          |                        |
| `payslips`                            | `manage-payroll`            |                        |
| `salary-advances`                     | `manage-payroll`            |                        |
| `individual-payslips`                 | NULL                        | 个人数据，角色可见即可 |
| `commission-rules`                    | `manage-doctor-claims`      |                        |
| `doctor-performance-report`           | `view-reports`              |                        |
| `holidays`                            | `manage-holidays`           |                        |
| `leave-types`                         | `manage-leave`              |                        |
| `leave-requests`                      | `manage-leave`              |                        |
| `leave-requests-approval`             | `manage-leave`              |                        |
| 所有报表 URL                          | `view-reports`              |                        |
| `expense-categories`                  | `manage-expenses`           |                        |
| `expenses`                            | `manage-expenses`           |                        |
| `branches`                            | `view-branches`             |                        |
| `chairs`                              | `view-chairs`               |                        |
| `users`                               | `view-users`                |                        |
| `roles`                               | `manage-roles`              |                        |
| `role-permissions`                    | `manage-role-permissions`   |                        |
| `system-maintenance`                  | `manage-system-maintenance` |                        |
| `home`                                | NULL                        | 所有人可见             |

---

## 八、完整文件清单

### Step 1–2：角色 slug 改造

#### 新建 1 个文件

| 文件 | 说明 |
| ---- | ---- |
| `database/migrations/..._add_slug_to_roles_table.php` | roles 表加 slug 列 + 回填数据 + name 改中文 |

#### 修改约 50 个文件

全局将 `->name == 'Super Administrator'` 等硬编码改为 `->slug === 'super-admin'` 等 slug 匹配。

### Step 3：动态菜单核心

#### 新建 7 个文件

| 文件                                                         | 说明                                |
| ------------------------------------------------------------ | ----------------------------------- |
| `app/Models/MenuItem.php`                                    | Eloquent 模型（含 roles/permission 关系） |
| `app/Services/MenuService.php`                               | 菜单树构建 + 缓存 + 权限过滤       |
| `database/migrations/..._create_menu_items_table.php`        | `menu_items` 建表                   |
| `database/migrations/..._create_role_menu_items_table.php`   | `role_menu_items` 建表              |
| `database/seeders/MenuItemsSeeder.php`                       | 93 条菜单 + 249 条角色关联          |
| `resources/views/partials/sidebar-dynamic.blade.php`         | 统一侧边栏容器                      |
| `resources/views/partials/_menu_node.blade.php`              | 递归菜单项组件                      |

#### 修改 7 个文件

| 文件                                        | 改动                                       |
| ------------------------------------------- | ------------------------------------------ |
| `app/Role.php`                              | 追加 `menuItems()` BelongsToMany 关系      |
| `resources/views/layouts/app.blade.php`     | sidebar include 改为 `sidebar-dynamic`     |
| `Modules/SuperAdmin/.../master.blade.php`   | 同上                                       |
| `Modules/Doctor/.../master.blade.php`       | 同上                                       |
| `Modules/Nurse/.../master.blade.php`        | 同上                                       |
| `Modules/Receptionist/.../master.blade.php` | 同上                                       |
| `app/Providers/AppServiceProvider.php`      | 添加 View Composer                         |

### Step 4：菜单管理 UI

#### 新建 5 个文件

| 文件 | 说明 |
| ---- | ---- |
| `app/Http/Controllers/MenuItemController.php` | 控制器（6 个方法：index/tree/store/update/destroy/reorder） |
| `resources/views/menu_items/index.blade.php` | 管理页面（左右分栏 + 树 + 编辑表单 + JS） |
| `resources/lang/zh-CN/menu_items.php` | 中文翻译（30+ key） |
| `resources/lang/en/menu_items.php` | 英文翻译 |
| `database/migrations/..._seed_menu_items_permission.php` | 种子迁移：创建 `manage-menu-items` 权限并分配给 super-admin |

#### 修改 4 个文件

| 文件 | 改动 |
| ---- | ---- |
| `routes/web.php` | 新增 6 条菜单管理路由 |
| `resources/lang/zh-CN/menu.php` | + `'menu_management' => '菜单管理'` |
| `resources/lang/en/menu.php` | + `'menu_management' => 'Menu Management'` |
| `database/seeders/PermissionsTableSeeder.php` | + `manage-menu-items` 权限记录 |

### 保留但标记废弃（过渡期保留，验证无误后删除）

| 文件                                                      | 说明       |
| --------------------------------------------------------- | ---------- |
| `resources/views/partials/sidebar-admin.blade.php`        | 不再被引用 |
| `resources/views/partials/sidebar-superadmin.blade.php`   | 同上       |
| `resources/views/partials/sidebar-doctor.blade.php`       | 同上       |
| `resources/views/partials/sidebar-nurse.blade.php`        | 同上       |
| `resources/views/partials/sidebar-receptionist.blade.php` | 同上       |

---

## 九、实施步骤

### Step 1：角色 slug 改造 ✅

1. 创建迁移：roles 表加 `slug` 列 + 唯一索引 + 回填数据 + `name` 改中文
2. 全局替换约 50 个文件中的角色名硬编码为 slug 匹配
3. 运行迁移，验证所有角色判断逻辑正常

### Step 2：动态菜单核心实现 ✅

1. 建表迁移（`menu_items` + `role_menu_items`）+ MenuItem 模型
2. 修改 Role 模型追加 `menuItems()` BelongsToMany 关系
3. 编写 MenuItemsSeeder（93 条菜单 + 249 条角色关联，含 6 组合并节点）
4. 编写 MenuService（树构建 + 缓存 + 权限过滤）
5. 创建 sidebar-dynamic + _menu_node blade
6. AppServiceProvider 注册 View Composer
7. 修改 5 个 layout 文件的 sidebar include
8. 运行迁移 + seeder
9. 分别用 5 个角色登录，逐项对比菜单是否与旧 sidebar 一致

### Step 3：菜单管理 UI ✅

1. 创建权限种子迁移（`manage-menu-items` 权限 + 分配 super-admin）
2. 创建翻译文件（zh-CN + en `menu_items.php`）+ menu.php 菜单 key
3. 创建 MenuItemController（6 个方法）
4. 添加 6 条路由到 `routes/web.php`
5. 创建管理页面 `menu_items/index.blade.php`（左右分栏）
6. 更新 MenuItemsSeeder 添加"菜单管理"菜单项
7. 运行迁移，验证页面加载正常

### Step 4：收尾

1. 确认无误后删除 5 个旧 sidebar 文件
2. 清理 `FunctionsHelper::navigation()` 中不再需要的逻辑

---

## 十、风险与降级

| 风险                          | 降级措施                                            |
| ----------------------------- | --------------------------------------------------- |
| 菜单渲染与旧 sidebar 不一致  | 保留旧文件，layout 改回即可秒级回滚                 |
| `role_menu_items` 查询性能    | 按角色缓存，实际只查 1 次/小时                      |
| 种子数据遗漏菜单项            | 用脚本对比旧 blade 的 `url()` 调用与种子数据        |
| Metronic JS 展开/高亮行为异常 | sidebar-dynamic 保持完全相同的 HTML 结构和 class 名 |

---

## 十一、菜单管理 UI

在系统设置中新增"菜单管理"页面，仅 Super Administrator 可访问（权限 `manage-menu-items`）。

### 11.1 页面结构

采用**左右分栏**布局。左侧树形面板展示菜单层级，每个节点显示**翻译后的名称**和**URL 路径**（灰色小字）；右侧为编辑/新增表单。

```
┌──────────────────────────────────────────────────────────┐
│  菜单管理                                     [新增菜单项] │
├───────────────────────┬──────────────────────────────────┤
│                       │                                  │
│   菜单树              │   编辑表单                        │
│                       │                                  │
│   ▸ 工作台  home      │   标题键: menu.patients_list      │
│   ▾ 患者中心          │   预览:   患者列表                 │
│     ▾ 患者档案        │   URL:    patients                │
│       · 患者列表  ←   │   图标:   icon-list               │
│         patients      │   父节点: [患者档案 ▾]             │
│       · 患者标签      │   权限:   [view-patients ▾]       │
│         patient-tags  │   排序:   10                      │
│       · 患者来源      │   启用:   ✓                       │
│     ▸ 会员管理        │                                  │
│       members         │   可见角色:                        │
│     ...               │   ☑ 超级管理员                    │
│                       │   ☑ 管理员                        │
│                       │   ☐ 医生                          │
│                       │   ☐ 护士                          │
│                       │   ☐ 前台                          │
│                       │                                  │
│                       │   [保存]  [删除]                   │
└───────────────────────┴──────────────────────────────────┘
```

**树节点显示规则**：

- 第一行：图标 + `__($item->title_key)` 翻译后的标题
- 第二行：URL 路径（灰色 10px 小字，最宽 140px 溢出省略）
- 无 URL 的目录节点不显示第二行
- 不显示类型标签（目录/链接/混合）或角色标签，保持简洁

### 11.2 功能列表

| 功能 | 说明 |
| ---- | ---- |
| **树形展示** | 左侧展示 3 级菜单树，点击节点在右侧加载编辑表单 |
| **拖拽排序** | 支持拖拽调整同级排序和父子层级 |
| **新增菜单项** | 选择父节点 → 填写标题键/URL/图标 → 选择权限 → 勾选角色 |
| **编辑菜单项** | 修改标题键、URL、图标、权限、排序、启用状态 |
| **标题预览** | 输入 title_key 时实时显示 `__()` 翻译结果（AJAX） |
| **角色分配** | 复选框勾选该菜单项对哪些角色可见（操作 `role_menu_items` 表） |
| **权限关联** | 下拉选择关联的权限（从 `permissions` 表加载，按模块分组，可选空） |
| **删除** | 删除菜单项（含子项级联删除），需二次确认 |
| **启用/禁用** | 切换 `is_active` 字段，禁用后所有角色不可见 |
| **缓存刷新** | 每次增/删/改/排序后自动调用 `MenuService::clearAllCache()` |

### 11.3 路由

```
GET    /menu-items                → MenuItemController@index     （页面）
GET    /menu-items/tree           → MenuItemController@tree      （AJAX 获取树结构 JSON）
POST   /menu-items                → MenuItemController@store     （新增）
PUT    /menu-items/{id}           → MenuItemController@update    （编辑）
DELETE /menu-items/{id}           → MenuItemController@destroy   （删除，级联子项）
POST   /menu-items/reorder        → MenuItemController@reorder   （拖拽排序）
```

### 11.4 权限控制

- 新增权限：`manage-menu-items`（仅 Super Administrator 拥有）
- Controller 中间件：`$this->middleware('can:manage-menu-items')`
- 权限通过种子迁移自动创建并分配

### 11.5 Controller 方法

| 方法 | 说明 |
| ---- | ---- |
| `index()` | 加载角色列表、权限列表（按模块分组）、顶级菜单项（用于父级下拉），返回视图 |
| `tree()` | 递归构建完整菜单树 JSON（含每个节点的 `role_ids` 数组），供前端渲染 |
| `store(Request)` | 验证 → 创建菜单项 → 同步角色关联 → 清缓存 → 返回 JSON |
| `update(Request, $id)` | 验证 → 防止设为自身子节点 → 更新 → 同步角色 → 清缓存 → 返回 JSON |
| `destroy($id)` | 递归删除子项 → detach 角色关联 → 清缓存 → 返回 JSON |
| `reorder(Request)` | 接收 `items[].{id, sort_order, parent_id}` 数组 → 批量更新 → 清缓存 |

### 11.6 涉及文件

| 文件 | 说明 |
| ---- | ---- |
| `app/Http/Controllers/MenuItemController.php` | 控制器（6 个方法） |
| `resources/views/menu_items/index.blade.php` | 管理页面（左右分栏 + 树渲染 + 编辑表单 + AJAX JS） |
| `resources/lang/zh-CN/menu_items.php` | 中文翻译（30+ key：页面标题、字段标签、操作提示） |
| `resources/lang/en/menu_items.php` | 英文翻译 |
| `database/migrations/2026_02_22_000003_seed_menu_items_permission.php` | 权限种子迁移 |
| `routes/web.php` | 新增 6 条路由（在 system-maintenance 路由之后） |
| `database/seeders/MenuItemsSeeder.php` | 在系统设置区段新增"菜单管理"菜单项 |
| `database/seeders/PermissionsTableSeeder.php` | 新增 `manage-menu-items` 权限记录 |
| `resources/lang/zh-CN/menu.php` | + `'menu_management' => '菜单管理'` |
| `resources/lang/en/menu.php` | + `'menu_management' => 'Menu Management'` |

---

## 十二、角色名国际化

### 12.1 现状

角色名以英文硬编码存储在 `roles.name` 字段中，代码中约 **100 处**直接用字符串匹配：

| 角色名（当前） | 出现位置 |
| -------------- | -------- |
| `Super Administrator` | FunctionsHelper、AuthServiceProvider、seeders、tests、迁移 |
| `Administrator` | 同上 |
| `Doctor` | 同上 + 模块 config |
| `Nurse` | 同上 + 模块 ServiceProvider/RouteServiceProvider |
| `Receptionist` | 同上 + 模块 config |

**影响范围**：约 50 个文件、100 处引用。

### 12.2 改造方案

#### 方案：roles 表增加 `slug` 字段，代码改用 slug 匹配，`name` 字段存国际化显示名

**表结构变更**：

```sql
ALTER TABLE roles ADD COLUMN slug VARCHAR(50) NOT NULL AFTER name;
-- slug 为英文标识符，不可变；name 改为可自定义的显示名
```

**数据**：

| id | slug | name（可改为中文） |
| -- | ---- | ---- |
| 1 | `super-admin` | 超级管理员 |
| 2 | `admin` | 管理员 |
| 3 | `doctor` | 医生 |
| 4 | `nurse` | 护士 |
| 5 | `receptionist` | 前台 |

**代码改造**：

```php
// 之前（硬编码英文名）
if ($user->UserRole->name == "Super Administrator") { ... }

// 之后（用 slug 匹配）
if ($user->UserRole->slug === 'super-admin') { ... }
```

**改造点清单**：

| 文件/位置 | 改动 | 说明 |
| --------- | ---- | ---- |
| `App/Role.php` | `$fillable` 增加 `slug` | 模型 |
| `database/migrations/..._add_slug_to_roles.php` | 新增迁移 | 加 slug 列 + 唯一索引 + 回填数据 |
| `database/seeders/RolesTableSeeder.php` | 加 slug 字段 | 种子数据 |
| `App/Http/Helper/FunctionsHelper.php` (5 处) | `->name ==` → `->slug ===` | 侧边栏选择 |
| `App/Providers/AuthServiceProvider.php` (7 处) | 同上 | 权限检查 |
| `database/seeders/DefaultRolePermissionsSeeder.php` (5 处) | `where('name',...)` → `where('slug',...)` | 权限种子 |
| `database/migrations/*_seed_*_permission.php` (2 处) | 同上 | 权限迁移 |
| `Modules/Nurse/Providers/*.php` (7 处) | 同上 | 模块路由注册 |
| `Modules/*/Config/config.php` (3 处) | 同上 | 模块配置 |
| `tests/Feature/*.php` (~30 处) | 同上 | 测试用例 |
| `resources/views/*.blade.php` (~3 处) | 视图中角色判断改 slug | 视图层 |

**迁移脚本回填逻辑**：

```php
// 迁移中自动回填 slug
$mapping = [
    'Super Administrator' => 'super-admin',
    'Administrator'       => 'admin',
    'Doctor'              => 'doctor',
    'Nurse'               => 'nurse',
    'Receptionist'        => 'receptionist',
];
foreach ($mapping as $name => $slug) {
    DB::table('roles')->where('name', $name)->update([
        'slug' => $slug,
        'name' => match($slug) {
            'super-admin'  => '超级管理员',
            'admin'        => '管理员',
            'doctor'       => '医生',
            'nurse'        => '护士',
            'receptionist' => '前台',
        },
    ]);
}
```

### 12.3 与动态菜单的关系

- 动态菜单通过 `role_menu_items.role_id` 关联 `roles.id`，**不受角色名变更影响**
- `FunctionsHelper::navigation()` 改用 slug 后，动态菜单替换 sidebar 时可一并简化该方法
- 角色管理 UI 中 `name` 字段变为可编辑的显示名，`slug` 为系统内部标识不可修改

### 12.4 实施顺序

```
Step 1: roles 表加 slug 字段（迁移 + 回填 + name 改中文）          ✅ 已完成
Step 2: 全局替换代码中的角色名匹配为 slug 匹配（~50 文件）          ✅ 已完成
Step 3: 动态菜单核心实现（第三～十节）                              ✅ 已完成
Step 4: 菜单管理 UI（第十一节）                                    ✅ 已完成
```

Step 1-2 独立于动态菜单先行实施，降低了后续改造风险。

---

## 十三、不包含在本次方案中

- **FunctionsHelper 重构** — 本方案不改 `navigation()` 逻辑，仅改 sidebar include（Step 4 收尾时可一并简化）
- **Permission 新增/拆分** — 沿用现有 47 个权限，新增 `manage-menu-items` 和 `manage-system-maintenance` 两个管理权限
- **旧 sidebar 删除** — 5 个旧 sidebar blade 文件在过渡期保留，确认无回归后删除
