---
name: fix-bug
description: Bug 诊断与修复，支持"仅诊断"和"诊断+自主修复"两种模式，强制根因分析流程，减少猜测性修复
---

## Usage

### How to Invoke This Skill

```
/fix-bug <Bug 描述或错误日志>
```

### What This Skill Does

当调用此技能时，根据用户意图自动选择模式：

| 模式 | 触发条件 | 行为 |
|------|---------|------|
| **诊断模式** | 用户说"看看"、"分析"、"什么原因" | 只分析根因，输出诊断报告，不改代码 |
| **修复模式** | 用户说"修复"、"解决"、直接贴错误日志 | 诊断 → 写测试 → 循环修复 → 验证通过 |

如果不确定，默认进入**修复模式**。

### Common Use Cases

| 场景 | 用法 |
|------|------|
| 只想了解原因 | `/fix-bug 分析一下为什么 /patients 页面 500 错误` |
| 页面报错要修复 | `/fix-bug 访问 /patients 时 500 错误，日志：[粘贴]` |
| 数据异常 | `/fix-bug 发票金额计算结果多出小数位` |
| 功能失效 | `/fix-bug 预约创建成功但不显示在日历上` |
| 回归问题 | `/fix-bug 升级后 PDF 导出空白` |

---

## Phase 1: 根因分析（两种模式共用）

### Step 1: 收集证据（不做任何修改）

1. **读取错误信息** — 完整的报错、stack trace、日志
2. **读取相关配置** — `.env`、`config/*.php`、路由定义
3. **读取相关代码** — Controller、Model、Service、View、Middleware
4. **记录发现** — 列出已确认的事实

### Step 2: 追踪调用链

从错误发生点 **逆向** 追踪：

```
错误位置 → 调用它的方法 → 路由/中间件 → 请求入口
```

在每一层检查：
- 参数传递是否正确？
- 配置值是否符合预期？
- 数据库查询条件是否正确？
- 是否有中间件/Event 在中途修改了数据？

### Step 3: 形成假设并验证

- 对每个可能的原因，找到 **代码或配置中的证据** 来确认或排除
- **禁止猜测**：如果无法用证据验证，明确告知用户"需要更多信息"
- 如果第一个假设被否定，**从头开始**，不要在错误假设上修修补补

### 诊断模式到此结束 → 输出诊断报告

```
## 根因分析

**错误现象：** [一句话描述]

**根因：** [具体原因，指向文件:行号]

**证据：**
1. [证据1：代码/配置/日志引用]
2. [证据2：...]

**修复建议：** [具体改动方案]

**影响范围：** [这个修复是否影响其他功能]
```

---

## Phase 2: 自主修复（仅修复模式）

### Step 4: 写失败测试

1. 在 `tests/` 目录下创建或修改测试文件
2. 测试应精准复现 bug 的条件
3. 运行测试，**确认它确实失败**
4. 如果测试直接通过，说明对 bug 的理解有误 — 回到 Step 1

```bash
php artisan test --filter=测试方法名
```

### Step 5: 循环修复（核心步骤）

1. 基于根因分析实现修复
2. 运行测试
3. **如果测试失败**：
   - 分析失败原因
   - 换一种修复方案（不要在同一个错误思路上反复尝试）
   - 至少尝试 **3 种不同方案** 再向用户求助
4. **如果测试通过**：进入 Step 6

### Step 6: 全面验证

1. 对所有修改的 PHP 文件运行 `php -l` 语法检查
2. 运行完整测试套件确认无回归：`php artisan test`
3. 检查修改是否影响了其他文件（grep 引用关系）

### 修复模式输出格式

```
## Bug 修复报告

**问题：** [一句话描述 bug]

**根因：** [具体原因，指向文件:行号]

**修复方案：** [改了什么，为什么这样改]

**测试验证：**
- 新增测试：[测试文件:方法名] ✅ 通过
- 全量测试：php artisan test ✅ X passed

**改动文件：**
- [文件1]: [改动说明]
- [文件2]: [改动说明]
```

---

## 常见错误速查

### Laravel 常见错误

| 错误 | 常见根因 | 首先检查 |
|------|---------|---------|
| `Class not found` | namespace/import 错误、composer autoload | `composer dump-autoload`，检查 `use` 语句 |
| `Route not found` | 路由未注册、中间件拦截 | `php artisan route:list`，检查 RouteServiceProvider |
| `SQLSTATE` | 表/字段不存在、类型不匹配 | 检查 migration，`php artisan migrate:status` |
| `View not found` | 路径拼写、模块视图命名空间 | 检查 `view()` 参数和 Blade 文件位置 |
| `Permission denied` | Gate/Policy 配置、角色权限 | 检查 AuthServiceProvider 和 middleware |
| `TokenMismatchException` | CSRF token 缺失 | 检查表单 `@csrf`、AJAX header |

### 数据类问题

| 现象 | 常见根因 | 首先检查 |
|------|---------|---------|
| 数据不显示 | `deleted_at` 未处理、查询条件错误 | 检查是否用了 `SoftDeletes` trait |
| 数据重复 | 缺少唯一约束、重复提交 | 检查 migration 和前端防重复提交 |
| 金额不对 | 精度丢失、计算顺序 | 检查 `decimal` 字段定义和计算逻辑 |
| 关联数据缺失 | 外键值为 null、关联方法错误 | 检查 Model 的 `belongsTo`/`hasMany` 定义 |

---

## 核心原则

### 必须做的

- **先读后改** — 读完所有相关文件后再提出修复方案
- **证据驱动** — 每个结论都要有对应的代码/配置/日志作为证据
- **最小修改** — 只改根因，不趁机重构或"改善"周围代码
- **解释原因** — 修复时说明"问题出在 X 文件第 Y 行，因为 Z 原因"

### 禁止做的

- **不要猜测根因** — 没有证据就不下结论
- **不要堆叠修复** — 一个 bug 只需一个修复，不要改 5 个地方"以防万一"
- **不要辩护错误诊断** — 如果用户指出诊断有误，立即放弃当前假设，从证据重新分析
- **不要中途提问**（修复模式）— 至少尝试 3 种方案后再求助
- **不要跳过测试**（修复模式）— 没有测试验证的修复不算完成
